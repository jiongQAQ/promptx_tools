# JSON 使用说明文档

本文档介绍论文生成系统中使用的 6 个核心 JSON 文件：  
`outline.json`、`content.json`、`files.json`、`manifest.json`、`workflow.json`、`workflow-status.json`。  
它们分别用于 大纲管理、章节内容、资料库、导出清单、生成流程定义、执行状态记录。

---

## 1. outline.json —— 大纲结构

### 功能
1. 存储整篇论文的章节树结构（ID、标题、层级）。
2. 唯一数据源：章节结构修改时，同步更新 content.json。

### 样例
```json
{
  "title": "论文大纲",
  "nodes": [
    {
      "id": "1",
      "title": "第1章 绪论",
      "children": [
        { "id": "1.1", "title": "研究背景与意义", "children": [] },
        { "id": "1.2", "title": "国内外研究现状", "children": [] }
      ]
    }
  ]
}

字段说明
	1.	id：章节编号，唯一键，用来和 content.json 对齐。
	2.	title：章节标题。
	3.	children：子节点数组。

⸻

2. content.json —— 章节内容

功能
	1.	存储每个章节的正文、图、表、资料引用、上下文配置。
	2.	和 outline.json 的 id 一一对应。
	3.	用户在页面里编辑的内容都保存在这里。

样例

{
  "docId": "paper-001",
  "defaultLength": { "unit": "char", "target": 900 },
  "contents": {
    "1.1": {
      "text": "",
      "textPrompt": "撰写‘研究背景与意义’正文。",
      "length": { "unit": "char", "target": 800 },
      "useFiles": [
        { "fileId": "file-001", "descriptor": "提取背景数据支撑本节论述" }
      ],
      "contextChapters": ["1"],
      "figures": [],
      "tables": []
    }
  }
}

字段说明
	1.	text：生成或人工编辑后的正文。
	2.	textPrompt：本节默认生成提示词。
	3.	length：目标字数设置。
	4.	useFiles：引用的资料（关联 files.json 的 fileId + 描述词）。
	5.	contextChapters：勾选的上下文章节 ID。
	6.	figures：图数组（含 prompt、UML 代码、渲染结果、状态）。
	7.	tables：表数组（含 prompt、schema、数据、状态）。

⸻

3. files.json —— 全局资料库

功能
	1.	存储论文所需的所有资料（文件只上传一次）。
	2.	自动生成摘要 bullets 和默认调用说明。
	3.	各章节在 content.json 里只引用 fileId。

样例

{
  "files": [
    {
      "fileId": "file-001",
      "name": "需求说明书.pdf",
      "type": "pdf",
      "path": "/uploads/req-v2.pdf",
      "hash": "sha256:xxx",
      "tags": ["需求", "业务流程"],
      "summary": {
        "title": "需求说明书",
        "bullets": [
          "需支持会员/下单/支付/售后",
          "并发峰值 2000 qps，读写比 7:3"
        ]
      },
      "defaultDescriptor": "用于约束性能和业务需求的依据。"
    }
  ]
}

字段说明
	1.	fileId：文件唯一 ID。
	2.	summary：自动生成的摘要（可编辑）。
	3.	defaultDescriptor：默认调用说明。

⸻

4. manifest.json —— 导出清单

功能
	1.	最终导出 Word 的唯一输入。
	2.	把大纲与内容拍平，合并正文、图、表、样式。
	3.	保证即使某些图表失败，也能正常导出（插入占位符）。

样例

{
  "docId": "paper-001",
  "title": "基于微信小程序的系统设计与实现",
  "outlineOrder": ["1", "1.1", "1.2"],
  "sections": [
    {
      "id": "1.1",
      "title": "研究背景与意义",
      "level": 2,
      "text": "这里是正文内容...",
      "figures": [
        { "id": "Fig-1-1-1", "label": "图1-1-1 研究背景图", "path": "exports/Fig-1-1-1.png", "status": "success" }
      ],
      "tables": [
        {
          "id": "Tab-1-1-1",
          "label": "表1-1-1 背景数据表",
          "schema": ["字段", "描述"],
          "rows": [["用户","系统使用者"]],
          "status": "success"
        }
      ]
    }
  ],
  "styles": {
    "heading1": { "font": "Times New Roman", "size": 28, "bold": true, "alignment": "center" },
    "body": { "font": "Times New Roman", "size": 22, "line": 1.5 }
  },
  "page": { "margin": { "top": 1440, "right": 1440, "bottom": 1440, "left": 1440 } }
}


⸻

5. workflow.json —— 工作流定义

功能
	1.	描述论文生成流程：哪些章节、执行顺序、调用哪些工具、并发与重试策略。
	2.	可定义全局跑，也可单章节重跑。

样例

{
  "version": "1.0",
  "docId": "paper-001",
  "selectors": { "sections": ["*"], "onlyStatus": ["draft","reviewed"] },
  "modes": { "dryRun": false, "concurrency": 3, "stopOnError": false },
  "steps": [
    { "id": "ctx", "type": "compose_context", "foreach": "section" },
    { "id": "text", "type": "generate_text", "foreach": "section" },
    { "id": "uml-gen", "type": "generate_uml_code", "foreach": "figure" },
    { "id": "uml-render", "type": "render_uml", "foreach": "figure" },
    { "id": "table", "type": "generate_table_data", "foreach": "table" },
    { "id": "manifest", "type": "build_manifest" },
    { "id": "docx", "type": "export_docx" }
  ]
}

常见 step 类型
	1.	compose_context：合成上下文。
	2.	generate_text：调用 AI 生成正文。
	3.	generate_uml_code：调用 AI 生成 UML 代码。
	4.	render_uml：调用渲染器生成图片。
	5.	generate_table_data：AI 或 SQL 解析生成表数据。
	6.	build_manifest：打包导出清单。
	7.	export_docx：生成 Word 文档。

⸻

6. workflow-status.json —— 执行状态

功能
	1.	记录工作流每一步的运行情况：成功/失败/耗时/错误。
	2.	前端用来展示进度条、错误提示、支持重试。

样例

{
  "runId": "wf-20250923-001",
  "docId": "paper-001",
  "workflowFile": "workflow.json",
  "status": "completed",
  "startedAt": "2025-09-23T09:00:00Z",
  "endedAt": "2025-09-23T09:05:30Z",
  "steps": [
    {
      "id": "ctx",
      "type": "compose_context",
      "status": "success",
      "durationMs": 2100,
      "targets": [
        { "sectionId": "1.1", "status": "success", "log": "合成上下文 300 tokens" }
      ]
    },
    {
      "id": "uml-gen",
      "type": "generate_uml_code",
      "status": "failed",
      "targets": [
        { "sectionId": "3.2", "figureId": "Fig-3-2-1", "status": "failed", "errorMessage": "UML 语法错误" }
      ]
    }
  ]
}

状态值
	1.	success：执行成功。
	2.	failed：执行失败（附 errorMessage）。
	3.	skipped：跳过执行（如上一步失败）。
	4.	running：正在执行中。

⸻

整体使用逻辑
	1.	资料库：上传 → files.json。
	2.	大纲：编辑树 → outline.json。
	3.	章节：在页面配置正文/图/表 → content.json。
	4.	执行：调用 workflow.json → 产出 workflow-status.json。
	5.	导出：合并数据 → manifest.json → Word 生成。

