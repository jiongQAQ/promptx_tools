【流程 03｜正文与素材生成（基于 2-1 拆分文档｜不覆盖原文件｜统一使用 luban-uml）】

=== 路径定义 ===
<projectRoot> = $(pwd)  # 当前工作目录的绝对路径
使用说明：执行前请确保在项目根目录下运行，所有相对路径将基于此目录解析

目标
1 【严格执行模式】基于 <projectRoot>/paper/outline.json 与 <projectRoot>/paper/splits/content.chN.json（来自流程 2-1 的分章文件），**100%严格按照拆分内容定义生成正文、UML 代码与表格数据，不得遗漏任何项**。
2 【顺序执行要求】**必须按照章节号从小到大的顺序依次执行**：content.ch1.json → content.ch2.json → content.ch3.json → ... → content.chN.json，确保章节间引用和依赖关系正确。
3 【规范输出路径】不覆盖原始分章文件，仅生成新的运行产物：
   - 拆分文章结果 → <projectRoot>/paper/splits/content.chN.run.json
   - 若该文件已存在，则写入 <projectRoot>/paper/splits/content.chN.run.<YYYYMMDD-HHMMSS>.json
   - UML源码(.puml) → <projectRoot>/paper/exports/uml/
   - 图片(.png/.svg) → <projectRoot>/paper/exports/
   - 表格数据(.json) → <projectRoot>/paper/exports/tables/
4 【智能渲染与错误修复】所有 UML 图片必须调用工具 luban-uml 渲染，失败时智能诊断原因并自动修复，最多重试3次：
   - 例外（仅此一类）：**单体 ER 图**直接复用 <projectRoot>/paper/exports/tables/ 下由 1.2 产物生成的 **SVG** 文件，不再生成 puml 或渲染。
5 【自动样式标注】为所有生成元素添加 docx_type_* 样式字段，引用 <projectRoot>/templates/docx-styles.json 定义。
6 【完整性审查】生成完成后必须进行完整性审查，确保与拆分内容定义完全一致，不符合则强制修复。

输入
- <projectRoot>/paper/outline.json
- <projectRoot>/paper/splits/content.chN.json（由流程 2-1 输出的分章文件，**必须按章节号从小到大顺序处理**）
- <projectRoot>/source/ 源码目录
- <projectRoot>/CLAUDE.md （若存在）
- <projectRoot>/templates/docx-styles.json（DOCX样式配置，用于生成docx_type_*字段）

目录与命名规范
- 产物根：<projectRoot>/paper/exports/
- UML 目录：<projectRoot>/paper/exports/uml/        （存放 .puml 与 .png/.svg）
- 表格目录：<projectRoot>/paper/exports/tables/     （存放三线表 JSON 以及单体 ER 图 SVG 与总体 ER 图 puml/svg）
- 文件命名规则（通用图）：
  - 基础名：Fig-<chapter>-<index>__<slug>
  - slug：来源于 figureTitle（转小写，空格→-，去除非法字符，≤60 字符）
  - UML 源码路径：<projectRoot>/paper/exports/uml/Fig-<chapter>-<index>__<slug>.puml
  - 图片路径：  <projectRoot>/paper/exports/uml/Fig-<chapter>-<index>__<slug>.png
- 文件命名规则（数据库总体 ER 图与单体 ER 图例外）：
  - **单体 ER 图**：直接引用 <projectRoot>/paper/exports/tables/Tab-<tableName>.svg（不产 puml）
  - **数据库总体 ER 图**：
    - UML 源码：<projectRoot>/paper/exports/tables/ER-overview.puml
    - 图片：   <projectRoot>/paper/exports/tables/ER-overview.svg
- luban-uml 调用方式（通用图与总体 ER 图）：
  - 写入 .puml 文件后执行：
    luban-uml render --in "<pumlPath>" --out "<pngOrSvgPath>" --format png|svg
  - .puml 与输出图片同名（仅扩展名不同）。

执行规则

0 【预检查阶段】
   - **章节顺序验证**：确认当前执行的章节N是否为最小未完成章节号，若存在更小编号的未处理章节则终止执行。
   - 读取 content.chN.json，分析并生成完整的待办清单：
     • 需要生成正文的节点数量（plan.wantText=true）
     • 需要生成图片的节点数量（plan.wantFigure=true）
     • 需要生成表格的节点数量（plan.wantTable=true）
     • 数据库章节预期实体数量（通过扫描source/验证）
     • 功能设计章节预期功能数量（与outline.json对比）
   - 检查前置章节依赖：若当前章节引用了前面章节的图表，确认前置章节已完成生成。
   - 预检查失败则终止执行，必须先修复拆分文件或按正确顺序执行。

1 【严格文本生成】
   - 对 plan.wantText=true 的节点（含 list.items），使用 textPrompt，结合 <projectRoot>/source/ 与 <projectRoot>/CLAUDE.md 生成正文，写入 node.text。
   - 自动添加样式字段：node.docx_type_text = "body_text"
   - 学术化表达，正文字数必须遵循节点的 length 配置，例如：
     "length": { "unit": "char", "target": 900 } → 约 900 个中文汉字。
   - 容差范围：±8%（例如 828–972 个汉字），不达标则自动扩充内容。
   - 在节点 meta.length.ok 中标记 true|false。

2 【智能图生成与错误修复】
   - 对 plan.wantFigure=true 的节点，逐个执行 figurePlan。
   - 自动添加样式字段：figures[i].docx_type_label = "figure_caption"
   - **功能结构图须使用 WBS（PlantUML）格式**：
     - 使用 @startwbs/@endwbs；* 为根，** 为二级，*** 为三级；层次清晰、样式简洁。
     - 该类图按"通用图"命名规则生成 puml 与图片（存放于 <projectRoot>/paper/exports/uml/）。

   - 渲染流程（带智能错误诊断）：
     a) 生成PlantUML代码 → 保存到 .puml
     b) 调用 luban-uml 渲染为图片，**失败时启动智能诊断修复**：
        【第1次失败】→ 语法诊断与修复：
          • 检查缺少@startuml/@enduml → 自动补充
          • 检查括号/引号不匹配 → 自动配对
          • 检查非法字符 → 转义或移除
          • 检查中文乱码 → 添加!define编码声明
        【第2次失败】→ 内容诊断与修复：
          • 检查循环依赖 → 打破循环
          • 检查节点未定义 → 自动声明节点
          • 检查关系错误 → 修正关系类型
          • WBS层级错误 → 修正星号数量
        【第3次失败】→ 降级处理：
          • 简化UML内容，去除复杂特性
          • 生成基础图表格式
          • 记录详细诊断日志
        【最终失败】→ 生成占位图片（包含错误信息），status="failed_with_diagnosis"
     c) 成功后写回运行产物：
        - figures[i].umlCodePath = "<.puml 路径>"（若此图为"单体 ER 图"，则无需该字段）
        - figures[i].imagePath   = "<图片路径>"
        - figures[i].status      = "done" | "failed_with_diagnosis"
        - figures[i].docx_type_label = "figure_caption"

   - **功能详细设计章节的每个功能子项**：在 figurePlan 中的两类图（活动图、时序图）需按常规流程生成并渲染（非 ER 图，不属于例外）。

3 【表格生成与样式标注】
   - 对 plan.wantTable=true 的节点，逐个执行 tablePlan。
   - 按 schema 输出 JSON 数组 → 保存到 <projectRoot>/paper/exports/tables/Tab-<chapter>-<index>__<slug>.json
   - 写回运行产物并自动添加样式字段：
     - tables[i].dataPath = "<.json 路径>"
     - tables[i].status   = "done" | "failed"
     - tables[i].docx_type_label = "table_caption"
     - tables[i].docx_type_header = "table_header"
     - tables[i].docx_type_cell = "table_cell"

4 【列表型章节样式标注】（mode=list）
   - 遍历 items[]，对子项逐一执行上述逻辑（正文、图、表生成）。
   - 自动添加样式字段：
     - items[i].docx_type_text = "body_text"
     - items[i].docx_type_title = "list_item_title"
   - items 渲染为编号段落，不当作新标题。

5 【数据库设计章节完整覆盖】（必须完整覆盖｜单体 ER 图直接复用 SVG）
   - 判定条件：标题包含"数据库设计/数据库概念设计/数据库逻辑设计/ER"
   - 要求（完整性优先）：
     1. 从 <projectRoot>/source/ 中完整提取所有实体定义（ORM/建表 SQL/实体类），**一个不漏**。
     2. 与拆分文件预期实体数量对比验证，不一致则强制重新扫描。
     3. 为每个实体生成一个子项：
        - **单体结构图**：**不再生成 puml**，直接引用 **<projectRoot>/paper/exports/tables/Tab-<tableName>.svg**（来自 1.2）；若不存在则标记 status=failed。
        - **三线表 JSON**：引用 <projectRoot>/paper/exports/tables/Tab-<tableName>.json（来自 1.1）；若不存在则标记 status=failed。
        - **文本描述**：实体业务定位、关键字段、约束、关系。
        - 自动添加样式字段：docx_type_text = "body_text", docx_type_title = "entity_title"
     4. 在章节级别必须生成一张"数据库总体 ER 图"，包含所有实体及它们的关系（不得遗漏）：
        - 若 <projectRoot>/paper/exports/tables/ER-overview.svg 已存在：直接引用；
        - 否则自动生成 ER-overview.puml → 调用 luban-uml 渲染为 ER-overview.svg 并写回；失败则智能诊断修复。
        - 自动添加样式字段：docx_type_label = "figure_caption"
   - 失败时：报告"未发现实体定义"或"实体数量不匹配"，并标记章节 status=failed。

6 【完整性审查与强制修复】
   - 生成完成后，必须进行完整性审查：
     a) 对比拆分文件的预期与实际生成结果：
        - 预期正文节点数 vs 实际生成数
        - 预期图片数量 vs 实际生成数（含失败项）
        - 预期表格数量 vs 实际生成数（含失败项）
        - 数据库章节预期实体数 vs 实际生成数
     b) 不一致时强制修复：
        - 缺少正文：重新执行文本生成
        - 缺少图片：重新执行图片生成（含智能修复）
        - 缺少表格：重新执行表格生成
        - 缺少实体：重新扫描源码并生成
     c) 修复失败则标记详细原因，但不阻断整体流程
     d) 审查通过标准：≥95% 完整性（允许个别项标记为 failed 但原因明确）

7 【写入产物与完整性验证】
   - 每章运行产物落盘为 <projectRoot>/paper/splits/content.chN.run.json（或带时间戳的新文件）。
   - 写入前再次验证：所有 docx_type_* 字段已添加，所有路径为绝对路径。
   - 原始 <projectRoot>/paper/splits/content.chN.json 不得修改。

输出
1 新文件：
   - <projectRoot>/paper/splits/content.chN.run.json
   - <projectRoot>/paper/exports/uml/*.puml + *.png（或 .svg）
   - <projectRoot>/paper/exports/tables/*.json（以及单体 ER 图 SVG、总体 ER 图 puml/svg）
2 机器可读 JSON（stdout 单行）：
   {
     "status": "success",
     "project": "<projectName>",
     "outlinePath": "<projectRoot>/paper/outline.json",
     "contentPath": "<projectRoot>/paper/splits/content.chN.json",
     "runContentPath": "<projectRoot>/paper/splits/content.chN.run.json",
     "chaptersDone": 1,
     "completenessCheck": {
       "expected": { "text": <int>, "figures": <int>, "tables": <int>, "entities": <int> },
       "actual": { "text": <int>, "figures": <int>, "tables": <int>, "entities": <int> },
       "completenessRate": <float>,
       "passed": <boolean>
     },
     "figures": { "generated": <int>, "failed": <int>, "retryFixed": <int> },
     "tables":  { "generated": <int>, "failed": <int> },
     "docxStyles": { "added": <int>, "types": ["docx_type_text","docx_type_label",...] },
     "failList": [
       {"sectionId":"<id>","type":"figure|table|text|entity","name":"<标题或文件名>","reason":"<摘要>","fixed":"<boolean>"}
     ]
   }
3 人类可读检查报告：
   - **完整性审查结果**：预期 vs 实际生成数量；完整性比率（≥95% 通过）；审查通过状态
   - **正文生成统计**：成功/失败数量；字数达标/未达标；docx_type_text 样式添加情况
   - **图/表生成统计**：生成数、失败数、智能修复成功数；docx_type_label/header/cell 样式添加情况
   - **数据库设计覆盖情况**：实体总数、单体图（直接引用 SVG）/三线表生成或引用情况、总体 ER 图状态（沿用/新生成/智能修复/失败）
   - **智能错误诊断统计**：语法修复次数、内容修复次数、降级处理次数、最终失败数
   - **样式字段统计**：添加的 docx_type_* 字段总数、字段类型分布、样式引用验证结果
   - **失败清单**：节/子项 → 失败类型 → 文件名 → 诊断原因 → 修复尝试结果
   - **文件清单预览**：uml/ 和 tables/ 目录下新文件数、run.json 文件状态
   - **下一步建议**：可进入"流程 04 导出 Word"；若有失败项建议的修复方案

注意
- 必须用 luban-uml 渲染所有 UML 图片；**唯独单体 ER 图直接引用 <projectRoot>/paper/exports/tables/ 下的 SVG，不再生成 puml 或二次渲染**。
- 功能结构图必须使用 **WBS**（@startwbs/@endwbs，*/* */*** 表示层级）。
- 功能详细设计章节的每个功能子项需生成 **活动图** 与 **时序图**（常规渲染流程）。
- 数据库实体类必须完整覆盖，不得省略任何一个实体；总体 ER 图必须包含所有实体。
- 正文字数必须严格参考 length.target（允许 ±8% 容差），并在节点 meta.length.ok 中标记。
- 若生成失败，保留 .puml 或 .json 文件，status=failed，不影响整体流程。
- 禁止修改 <projectRoot>/paper/outline.json 与 <projectRoot>/paper/splits/content.chN.json。