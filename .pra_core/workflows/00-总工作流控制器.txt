【总工作流控制器｜自动化论文生成管道（01→01-1→01-2→02→02-1→03→DOCX导出）】

=== 路径定义 ===
<projectRoot> = $(pwd)  # 当前工作目录的绝对路径
使用说明：执行前请确保在项目根目录下运行，所有相对路径将基于此目录解析

目标
1 【自动化管道】提供一键式论文生成解决方案，自动按序执行所有工作流：01 → 01-1 → 01-2 → 02 → 02-1 → 03（所有章节）→ DOCX导出
2 【产物验证】每个工作流执行前检查上游产物的完整性和正确性（第一个流程01除外）
3 【故障恢复】支持从任意中断点恢复执行，自动跳过已完成的流程
4 【进度跟踪】提供详细的执行日志和进度报告，支持并行处理优化

输入
- <projectRoot>/source/ 源码目录（必须存在，包含实体类定义）
- <projectRoot>/CLAUDE.md （可选，提供项目说明和命名规范）
- <projectRoot>/templates/docx-styles.json（DOCX样式配置）
- <projectRoot>/templates/content.template.json（内容模板）

角色与工具配置
- **内容生成角色**：使用 `pra` 角色处理所有文本内容生成
  - 激活方式：action("pra")
  - 专长：本科计算机专业毕业论文写作，学术规范，技术表达
- **工具执行角色**：使用 `luban` 角色进行工具调用和管理
  - 激活方式：action("luban")
  - 专长：PromptX工具开发，沙箱执行，依赖管理

可用鲁班工具清单
- **@tool://1-1-single-er**：单体ER图生成工具
  - 功能：基于三线表JSON生成对应的SVG格式ER图
  - 使用：toolx("@tool://1-1-single-er", parameters)
- **@tool://json-chapter-splitter**：JSON章节拆分工具
  - 功能：将完整的content.json按章节拆分为独立文件
  - 使用：toolx("@tool://json-chapter-splitter", parameters)
- **@tool://luban-uml**：UML图表渲染工具
  - 功能：将PlantUML代码渲染为PNG/SVG图片
  - 使用：toolx("@tool://luban-uml", parameters)
- **@tool://thesis-to-docx**：论文DOCX导出工具
  - 功能：基于content.run.json和素材生成完整的DOCX文档
  - 使用：toolx("@tool://thesis-to-docx", parameters)

执行流程

阶段0【环境预检查】
- 验证必要目录存在：source/、templates/
- 验证必要文件存在：templates/docx-styles.json、templates/content.template.json
- 检查工具可用性：luban-uml、luban-docx
- 创建工作目录：paper/、paper/exports/、paper/splits/
- 环境检查失败则终止执行并给出修复建议

阶段1【实体识别与表格生成】- 流程01系列
1.1 执行【流程01-1｜实体类→三线表JSON】
    - **角色切换**：激活 `pra` 角色进行源码分析和中文命名
    - **执行方式**：action("pra") → 基于源码目录和CLAUDE.md生成三线表
    - **输入验证**：source/目录包含可识别的实体定义
    - **产物期望**：<projectRoot>/paper/exports/tables/Tab-*.json
    - **成功标准**：生成≥1个三线表JSON文件，包含完整的中英文字段映射

1.2 产物检查01-1：
    - 检查tables/目录下Tab-*.json文件数量和格式正确性
    - 验证每个JSON包含必要字段：tableName、tableCnName、columns
    - 失败则终止执行，报告具体缺失项

1.3 执行【流程01-2｜单体ER图批量生成】
    - **角色切换**：激活 `luban` 角色进行工具调用
    - **工具调用**：action("luban") → toolx("@tool://1-1-single-er", {inputPath: tables目录})
    - **输入验证**：上一步生成的所有Tab-*.json文件
    - **产物期望**：<projectRoot>/paper/exports/tables/Tab-*.svg
    - **成功标准**：每个JSON对应生成一个SVG文件

1.4 产物检查01-2：
    - 检查与Tab-*.json数量匹配的Tab-*.svg文件
    - 验证SVG文件可读性和完整性
    - 失败则终止执行，报告具体缺失项

阶段2【大纲与内容规划】- 流程02系列
2.1 产物检查01系列（前置验证）：
    - 确认tables/目录包含完整的JSON和SVG文件对
    - 统计实体数量，为后续规划提供基础数据

2.2 执行【流程02｜基于大纲预填content.json】
    - **角色切换**：激活 `pra` 角色进行学术内容规划
    - **执行方式**：action("pra") → 基于大纲模板和实体数据生成内容规划
    - **占位符替换**：自动识别并替换技术栈占位符（{{jishu1/2/3}}、{{functionname}}）
    - **输入验证**：templates/content.template.json格式正确
    - **产物期望**：<projectRoot>/paper/outline.json、<projectRoot>/paper/content.json
    - **成功标准**：content.json包含所有大纲章节的内容规划和数据库设计引用

2.3 产物检查02：
    - 验证outline.json结构完整性和占位符替换完成度
    - 验证content.json包含所有章节ID和必要字段
    - 检查数据库设计章节是否正确引用01系列产物
    - 失败则终止执行，报告具体问题

2.4 执行【流程02-1｜content.json按章拆分】
    - **角色切换**：激活 `luban` 角色进行数据处理
    - **工具调用**：action("luban") → toolx("@tool://json-chapter-splitter", {inputFile: content.json})
    - **输入验证**：上一步生成的content.json
    - **产物期望**：<projectRoot>/paper/splits/content.chN.json（N=1,2,3...）
    - **成功标准**：每个顶层章节对应生成一个拆分文件

2.5 产物检查02-1：
    - 验证拆分文件数量与content.json中顶层章节数量匹配
    - 检查每个content.chN.json结构完整性
    - 验证章节编号连续性
    - 失败则终止执行，报告具体问题

阶段3【正文与素材生成】- 流程03系列
3.1 产物检查02系列（前置验证）：
    - 确认所有拆分文件content.chN.json存在且格式正确
    - 统计各章节预期生成的正文、图表数量

3.2 章节顺序执行【流程03｜正文与素材生成】：
    - **严格按章节号从小到大顺序执行**：ch1 → ch2 → ch3 → ... → chN
    - **角色协作模式**：
      • **正文生成**：action("pra") → 专业学术写作，符合本科论文规范
      • **图表渲染**：action("luban") → toolx("@tool://luban-uml", {pumlCode, format})
      • **完整性审查**：action("pra") → 验证学术质量和规范性
    - 每个章节执行前验证：
      • 前置章节的run.json文件已存在
      • 当前章节为最小未完成章节号
      • 依赖的图表文件已生成
    - **智能错误修复**：UML渲染失败时自动诊断语法、内容、格式错误并修复
    - 产物期望（每章节）：
      • <projectRoot>/paper/splits/content.chN.run.json（含docx_type样式字段）
      • <projectRoot>/paper/exports/uml/*.puml + *.png/svg（新增图片）
      • <projectRoot>/paper/exports/tables/*.json（新增表格）
    - 成功标准（每章节）：完整性审查通过（≥95%）

3.3 全章节完成检查：
    - 验证所有章节的run.json文件存在
    - 统计总体生成情况：正文数、图片数、表格数
    - 检查样式字段添加完整性（docx_type_*）
    - 失败则报告未完成章节，支持单独重试

阶段4【DOCX导出】- thesis-to-docx工具调用
4.1 产物检查03系列（前置验证）：
    - 确认所有content.chN.run.json文件存在且完整
    - 验证exports/目录下素材文件完整性

4.2 执行DOCX导出：
    - **角色切换**：激活 `luban` 角色进行工具调用
    - **工具调用**：action("luban") → toolx("@tool://thesis-to-docx", {runJsonFiles, exportsDir, stylesConfig})
    - **输入文件**：所有content.chN.run.json + exports/目录素材 + docx-styles.json
    - **产物期望**：<projectRoot>/paper/output/论文.docx
    - **成功标准**：生成完整的DOCX文件，包含所有正文、图表、样式

4.3 最终验证：
    - **质量检查**：action("pra") → 验证DOCX文档的学术规范性
    - 检查DOCX文件大小和可读性
    - 验证文档结构完整性（章节、图表编号）
    - 生成最终报告

故障恢复与重试机制
1 【断点恢复】：
   - 自动检测已完成的流程产物
   - 从最后一个成功点继续执行
   - 支持指定起始流程：--start-from=02-1

2 【单流程重试】：
   - 支持重新执行指定流程：--retry=03-ch2
   - 保留其他已完成流程的产物
   - 清理目标流程的旧产物后重新生成

3 【并行优化】：
   - 流程03各章节支持并行执行（在依赖关系允许时）
   - 01-2单体ER图生成支持批量并行处理
   - 提供串行/并行模式选择：--parallel=true

输出
1 实时进度日志（角色协作模式）：
   [STAGE-0] 🔧 环境预检查...
   [STAGE-0] ✅ 工具可用：luban-uml, thesis-to-docx, json-chapter-splitter, 1-1-single-er

   [STAGE-1.1] 🎭 角色切换 → pra（学术写作专家）
   [STAGE-1.1] 📊 执行实体识别与中文命名...
   [STAGE-1.1] ✅ 发现8个实体，生成8个三线表JSON（完整中英文映射）
   [STAGE-1.2] 🔍 验证01-1产物...
   [STAGE-1.2] ✅ 验证通过：8个JSON文件格式正确

   [STAGE-1.3] 🎭 角色切换 → luban（工具执行专家）
   [STAGE-1.3] 🔧 调用 @tool://1-1-single-er
   [STAGE-1.3] ✅ 生成8个SVG单体ER图

   [STAGE-2.2] 🎭 角色切换 → pra（内容规划专家）
   [STAGE-2.2] 📝 基于实体数据生成学术内容规划...
   [STAGE-2.2] ✅ 替换占位符，生成content.json（9个章节）

   [STAGE-2.4] 🎭 角色切换 → luban（数据处理专家）
   [STAGE-2.4] 🔧 调用 @tool://json-chapter-splitter
   [STAGE-2.4] ✅ 拆分为9个独立章节文件

   [STAGE-3.2] 🎭 角色协作模式 → pra & luban
   [STAGE-3.2-CH1] 📝 pra：生成第1章学术正文...
   [STAGE-3.2-CH1] 🖼️ luban：渲染UML图表 @tool://luban-uml
   [STAGE-3.2-CH1] 🔍 pra：完整性审查（98%通过）
   [STAGE-3.2-CH1] ✅ 第1章完成：content.ch1.run.json
   ...

   [STAGE-4.2] 🎭 角色切换 → luban（DOCX导出专家）
   [STAGE-4.2] 🔧 调用 @tool://thesis-to-docx
   [STAGE-4.3] 🎭 角色切换 → pra（质量验证专家）
   [STAGE-4.3] ✅ DOCX文档生成完成（45页，学术规范检查通过）

2 机器可读总结（JSON）：
{
  "status": "success",
  "project": "<projectName>",
  "totalTime": "<HH:MM:SS>",
  "roleCollaborations": {
    "pra": {
      "activations": 5,
      "tasks": ["实体识别", "内容规划", "学术写作", "完整性审查", "质量验证"],
      "totalTime": "00:45:30"
    },
    "luban": {
      "activations": 4,
      "tools": ["@tool://1-1-single-er", "@tool://json-chapter-splitter", "@tool://luban-uml", "@tool://thesis-to-docx"],
      "totalTime": "00:38:15"
    }
  },
  "stages": {
    "01-1": { "status": "success", "role": "pra", "entities": 8, "time": "00:02:15" },
    "01-2": { "status": "success", "role": "luban", "tool": "@tool://1-1-single-er", "svgGenerated": 8, "time": "00:01:45" },
    "02": { "status": "success", "role": "pra", "chapters": 9, "placeholdersReplaced": 5, "time": "00:03:20" },
    "02-1": { "status": "success", "role": "luban", "tool": "@tool://json-chapter-splitter", "splitFiles": 9, "time": "00:00:30" },
    "03": {
      "status": "success",
      "roleMode": "collaborative",
      "chapters": [
        {"id": 1, "roles": ["pra", "luban"], "completeness": 0.98, "umlRenders": 3, "time": "00:08:15"},
        {"id": 2, "roles": ["pra", "luban"], "completeness": 1.0, "umlRenders": 4, "time": "00:06:45"}
      ],
      "totalTime": "01:15:30"
    },
    "docx-export": { "status": "success", "role": "luban", "tool": "@tool://thesis-to-docx", "fileSize": "2.5MB", "time": "00:01:20" }
  },
  "toolsUsage": {
    "@tool://1-1-single-er": { "calls": 1, "success": true, "outputs": 8 },
    "@tool://json-chapter-splitter": { "calls": 1, "success": true, "outputs": 9 },
    "@tool://luban-uml": { "calls": 23, "success": 21, "failures": 2, "autoFixed": 2 },
    "@tool://thesis-to-docx": { "calls": 1, "success": true, "outputs": 1 }
  },
  "finalOutput": "<projectRoot>/paper/output/论文.docx",
  "summary": {
    "entities": 8,
    "chapters": 9,
    "figures": 23,
    "tables": 15,
    "totalPages": 45,
    "academicQuality": "优秀",
    "docxStylesApplied": 156
  }
}

3 人类可读报告：
=== 🎓 毕业论文自动生成完成报告 ===
项目：<projectName>
总用时：01:23:45
最终输出：<projectRoot>/paper/output/论文.docx

🎭 角色协作统计：
- **pra角色**（学术写作专家）：激活5次，负责内容生成、学术规范、质量把控
- **luban角色**（工具执行专家）：激活4次，负责工具调用、图表渲染、数据处理

🔧 工具调用统计：
- @tool://1-1-single-er：1次调用，生成8个单体ER图SVG
- @tool://json-chapter-splitter：1次调用，拆分9个章节文件
- @tool://luban-uml：23次调用，成功21次，智能修复2次
- @tool://thesis-to-docx：1次调用，生成完整DOCX文档

各阶段执行情况：
✅ 阶段1-实体识别：[pra角色] 发现8个实体，生成完整中英文映射
✅ 阶段1-ER图生成：[luban角色] 调用1-1-single-er工具，生成8个SVG
✅ 阶段2-内容规划：[pra角色] 智能替换占位符，生成9个章节规划
✅ 阶段2-章节拆分：[luban角色] 调用json-chapter-splitter，拆分独立文件
✅ 阶段3-正文生成：[pra&luban协作] 9章全部完成，23个图表，15个表格
✅ 阶段4-DOCX导出：[luban+pra] 调用thesis-to-docx + 学术规范验证

学术质量指标：
- 📊 实体覆盖率：100%（8个实体全部识别和处理）
- 📝 章节完整性：100%（9个章节全部生成）
- 🖼️ 图表成功率：91%（23个图表，21个成功，2个智能修复）
- 🎯 完整性评分：98%（超过95%审查标准）
- 📋 学术规范：优秀（符合本科论文写作标准）

文件清单：
- **论文文档**：paper/output/论文.docx (2.5MB, 45页)
- **图片素材**：paper/exports/uml/ (23个UML图表文件)
- **表格数据**：paper/exports/tables/ (8个JSON + 8个SVG + 总体ER图)
- **运行产物**：paper/splits/ (9个content.chN.run.json，含156个样式字段)
- **源码产物**：paper/exports/uml/*.puml (可编辑的UML源码)

质量检查建议：
✅ DOCX文档已通过学术规范性检查
✅ 所有图表编号连续，正文中正确引用
✅ 样式字段完整，支持一键调整格式
✅ 章节结构符合本科毕业论文要求

下一步操作：
- 📖 打开生成的论文文档进行最终审校
- 🎨 如需调整格式，修改docx-styles.json后重新导出
- 🔄 如需重新生成特定章节：运行工作流03-chN
- 📊 如需重新生成图表：调用luban-uml工具
- 🎯 准备答辩：基于生成的内容制作PPT和演示Demo

命令行接口示例
# 完整执行
./run-master-workflow.sh

# 从指定阶段开始
./run-master-workflow.sh --start-from=02-1

# 重试特定流程
./run-master-workflow.sh --retry=03-ch2

# 并行模式
./run-master-workflow.sh --parallel=true

# 调试模式（详细日志）
./run-master-workflow.sh --debug=true

注意事项
- 确保在项目根目录执行，所有路径基于$(pwd)解析
- 首次执行建议使用串行模式确保稳定性
- 大型项目（>50个实体）建议分批处理或使用并行模式
- 保持source/目录结构稳定，避免执行过程中修改源码
- luban工具依赖需要提前安装和配置
- 生成过程中避免手动修改paper/目录下的中间文件