# 00.1 源码真相扫描

## 路径规范
projectRoot 取当前工作目录（pwd）的绝对路径

## 功能说明
自动扫描项目源码目录，识别真实的技术栈、框架版本、数据库结构等信息，生成source-truth.json文件，为后续UML图表生成提供真实性验证依据，**严防编造和夸大设计**。

## 目标任务
1. **技术栈识别**：扫描配置文件，识别实际使用的技术栈
2. **版本信息提取**：获取框架和库的精确版本信息
3. **模块功能映射**：基于源码结构识别真实实现的功能模块
4. **数据库结构分析**：分析实际的数据库实体和关系
5. **生成真相文件**：输出机器可读的source-truth.json

## 扫描范围与策略

### 后端技术扫描
**扫描文件**：
- `pom.xml` - Maven项目依赖
- `build.gradle` - Gradle项目依赖
- `package.json` - Node.js项目依赖
- `requirements.txt` - Python项目依赖
- `Cargo.toml` - Rust项目依赖

**提取信息**：
- 框架名称和版本（如 Spring Boot 2.7.18）
- 数据库类型（MySQL、PostgreSQL、MongoDB等）
- ORM框架（MyBatis、JPA、Sequelize等）
- 安全框架（Spring Security、JWT等）
- 其他核心依赖

### 前端技术扫描
**扫描文件**：
- `package.json` - 前端依赖和脚本
- `yarn.lock` / `package-lock.json` - 锁定版本
- `vite.config.js` / `webpack.config.js` - 构建配置
- `tsconfig.json` - TypeScript配置

**提取信息**：
- 前端框架（Vue、React、Angular等）
- UI库（Element Plus、Ant Design等）
- 状态管理（Vuex、Pinia、Redux等）
- 构建工具（Vite、Webpack等）

### 数据库结构扫描
**扫描目录**：
- `src/main/java/entity/` - Java实体类
- `models/` - 其他语言的模型目录
- `migrations/` - 数据库迁移文件
- `sql/` - SQL脚本文件

**提取信息**：
- 实体类名称和字段
- 表关系定义
- 索引和约束配置
- 数据库特定配置

### 功能模块识别
**扫描策略**：
- Controller/Router层分析 → 识别API端点
- Service层分析 → 识别业务逻辑模块
- 前端路由配置 → 识别用户界面功能
- 测试文件分析 → 验证功能完整性

## 输出结构

### source-truth.json 格式
```json
{
  "scanTime": "2024-09-29T10:30:00Z",
  "projectName": "canteen-rating",
  "backend": {
    "framework": "Spring Boot",
    "version": "2.7.18",
    "language": "Java",
    "languageVersion": "17",
    "database": {
      "type": "MySQL",
      "version": "8.0+",
      "orm": "MyBatis Plus 3.5.3.1"
    },
    "security": {
      "framework": "Spring Security",
      "authentication": "JWT",
      "library": "jsonwebtoken 0.11.5"
    },
    "dependencies": [
      {"name": "spring-boot-starter-web", "version": "2.7.18"},
      {"name": "mybatis-plus-boot-starter", "version": "3.5.3.1"}
    ]
  },
  "frontend": {
    "framework": "Vue",
    "version": "3.3.4",
    "ui": "Element Plus 2.3.8",
    "stateManagement": "Pinia 2.1.6",
    "buildTool": "Vite 4.4.5",
    "dependencies": [
      {"name": "vue", "version": "3.3.4"},
      {"name": "element-plus", "version": "2.3.8"}
    ]
  },
  "actualModules": [
    {
      "name": "user-auth",
      "evidence": ["UserController.java", "AuthService.java", "login.vue"],
      "endpoints": ["/api/auth/login", "/api/auth/register"],
      "implemented": true
    },
    {
      "name": "canteen-management",
      "evidence": ["CanteenController.java", "canteen-admin.vue"],
      "endpoints": ["/api/admin/canteen"],
      "implemented": true
    },
    {
      "name": "dish-rating",
      "evidence": ["RatingController.java", "rating.vue"],
      "endpoints": ["/api/user/rating"],
      "implemented": true
    }
  ],
  "entities": [
    {
      "name": "User",
      "tableName": "users",
      "fields": ["id", "username", "password", "email", "created_time"],
      "filePath": "src/main/java/com/example/entity/User.java"
    },
    {
      "name": "Dish",
      "tableName": "dishes",
      "fields": ["id", "name", "description", "price", "canteen_id"],
      "filePath": "src/main/java/com/example/entity/Dish.java"
    }
  ],
  "notImplemented": [
    "payment",
    "third-party-integration",
    "advanced-analytics"
  ],
  "prohibitedTechnologies": [
    "microservices",
    "GraphQL",
    "Redis",
    "Docker",
    "Kubernetes"
  ]
}
```

## 验证规则生成

### 技术白名单
基于扫描结果生成的允许技术清单：
```json
{
  "allowedBackend": ["Spring Boot", "MySQL", "MyBatis Plus", "Spring Security", "JWT"],
  "allowedFrontend": ["Vue 3", "Element Plus", "Pinia", "Vite", "Axios"],
  "allowedPatterns": ["MVC", "RESTful API", "Single Page Application"]
}
```

### 技术黑名单
明确禁止在UML图中出现的技术：
```json
{
  "prohibitedTechnologies": [
    "microservices",
    "GraphQL",
    "Redis",
    "Docker",
    "Kubernetes",
    "Message Queue",
    "API Gateway"
  ],
  "prohibitedPatterns": [
    "分布式架构",
    "容器化部署",
    "微服务拆分"
  ]
}
```

## 扫描工具实现

### 核心扫描逻辑
```javascript
class SourceTruthScanner {
  async scan(projectRoot) {
    const truth = {
      scanTime: new Date().toISOString(),
      projectName: this.extractProjectName(projectRoot)
    };

    // 扫描后端技术栈
    truth.backend = await this.scanBackend(projectRoot);

    // 扫描前端技术栈
    truth.frontend = await this.scanFrontend(projectRoot);

    // 扫描实际功能模块
    truth.actualModules = await this.scanModules(projectRoot);

    // 扫描数据库实体
    truth.entities = await this.scanEntities(projectRoot);

    // 生成禁用技术列表
    truth.prohibitedTechnologies = this.generateProhibitedList(truth);

    return truth;
  }
}
```

## 使用场景
- 在workflow 07执行前进行真实性验证
- 为PlantUML生成提供技术约束
- 防止过度设计和技术堆砌
- 确保文档与代码一致性

## 输出位置
- **主文件**：`<projectRoot>/paper/source-truth.json`
- **验证规则**：`<projectRoot>/paper/validation-rules.json`

## 前置条件
- 项目源码完整存在于source目录
- 配置文件格式正确且可解析
- 具备相应语言的解析能力

## 后续集成
生成的source-truth.json将被workflow 07使用，确保：
1. UML图中只使用真实存在的技术
2. 功能模块与源码实现一致
3. 架构设计不超出实际复杂度
4. 所有技术描述有源码证据支撑