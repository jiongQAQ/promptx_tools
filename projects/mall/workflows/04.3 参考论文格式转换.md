# 📄 参考论文格式转换

## 🎯 目标

将 Word/PDF 格式的参考论文转换为 Markdown 格式，以便后续工作流（04.5 参考论文结构解析）能够读取和分析。

**通用性设计**: 支持 .doc、.docx、.pdf 等常见文档格式，自动处理图片提取和格式保留。

## 📋 适用场景

当需要使用参考论文生成大纲时（Workflow 04 选择模式D）：
- 将 Word 格式的参考论文转为 Markdown
- 提取论文中的图片并保存到对应目录
- 保留原文档的格式信息（标题层级、列表等）
- 为 Workflow 04.5 提供可分析的 MD 文件

## 路径约定

```
<projectRoot>/
├── reference-papers/              # 标准化目录
│   ├── 原始论文.docx              # 输入：原始文档
│   ├── 原始论文.md                # 输出：转换后的MD
│   └── 原始论文_images/           # 输出：提取的图片
│       ├── image-001.png
│       ├── image-002.png
│       └── ...
└── tools/
    └── word-to-md-complete.py     # 转换工具
```

## 🔄 执行流程

### Phase 1: 检查参考论文文件

```bash
# 扫描 reference-papers 目录
Glob({
  "pattern": "*.{doc,docx,pdf}",
  "path": "reference-papers"
})
```

**判断逻辑**:
- ✅ **只有 MD 文件** → 跳过转换，直接进入 Workflow 04.5
- ⚠️ **只有 Word/PDF 文件** → 执行转换
- ⚠️ **既有 MD 又有 Word** → 询问用户是否重新转换
- ❌ **目录为空** → 提示用户放置参考论文

### Phase 2: 文档格式转换

#### 2.1 Word 转 Markdown (.docx → .md)

```bash
# 使用 word-to-md-complete.py 工具
python3 tools/word-to-md-complete.py "reference-papers/郭正云.docx"

# 输出:
# - reference-papers/郭正云.md
# - reference-papers/郭正云_images/*.png
```

**处理内容**:
- ✅ 标题层级 (# ## ### ####)
- ✅ 段落文本
- ✅ 列表（有序、无序）
- ✅ 表格
- ✅ 图片（提取并保存到 _images 目录）
- ✅ 加粗、斜体等格式
- ⚠️ 页眉页脚（忽略）
- ⚠️ 批注和修订（忽略）

#### 2.2 旧格式 Word 转换 (.doc → .docx → .md)

```bash
# Step 1: 使用 LibreOffice 转换为 .docx
soffice --headless --convert-to docx \
  "reference-papers/参考论文.doc" \
  --outdir reference-papers/

# Step 2: 再转换为 MD
python3 tools/word-to-md-complete.py \
  "reference-papers/参考论文.docx"
```

#### 2.3 PDF 转 Markdown (.pdf → .md)

```bash
# 使用 word-to-md-complete.py (内部调用 pdf2docx)
python3 tools/word-to-md-complete.py "reference-papers/参考论文.pdf"

# 注: PDF 转换质量取决于原文档质量
# 扫描版 PDF 可能需要 OCR
```

### Phase 3: 转换质量检查

**自动检查**:
```python
# 检查生成的 MD 文件
checks = {
    "file_exists": os.path.exists("reference-papers/郭正云.md"),
    "file_size": os.path.getsize("reference-papers/郭正云.md") > 1024,
    "has_headings": "# " in content or "## " in content,
    "has_images": len(glob("reference-papers/郭正云_images/*.png")) > 0
}
```

**人工检查建议**:
- [ ] 打开生成的 MD 文件，检查标题层级是否正确
- [ ] 检查图片是否正常提取和引用
- [ ] 验证关键章节内容是否完整
- [ ] 确认特殊符号和公式是否正确

### Phase 4: 转换完成确认

**输出信息**:
```
✅ 转换完成！

📄 文件信息:
  - 输入: reference-papers/郭正云.docx (8.2 MB, 66页)
  - 输出: reference-papers/郭正云.md (245 KB)
  - 图片: reference-papers/郭正云_images/ (38张图片, 12.5 MB)

📊 统计信息:
  - 一级标题: 7个
  - 二级标题: 23个
  - 三级标题: 41个
  - 表格: 5个
  - 图片: 38张
  - 总字数: 28,450字

🔄 下一步: 执行 Workflow 04.5 (参考论文结构解析)
```

## 🛠️ 依赖工具

### 已实现工具
- ✅ `tools/word-to-md-complete.py` - Word/PDF 转 Markdown
  - 支持 .docx, .doc, .pdf
  - 自动提取图片
  - 保留格式信息
  - 智能目录命名

### 系统依赖
- LibreOffice (处理 .doc 文件)
- python-docx (解析 Word)
- pdf2docx (PDF 转换，可选)

### 安装命令
```bash
# macOS
brew install --cask libreoffice

# 虚拟环境
source .venv/bin/activate
pip install python-docx pdf2docx
```

## 📊 支持的文档格式

| 格式 | 支持情况 | 转换质量 | 备注 |
|-----|---------|---------|------|
| .docx | ✅ 完全支持 | ⭐⭐⭐⭐⭐ | 推荐格式 |
| .doc | ✅ 支持 | ⭐⭐⭐⭐ | 需 LibreOffice |
| .pdf | ⚠️ 部分支持 | ⭐⭐⭐ | 取决于源质量 |
| .rtf | ⚠️ 实验性 | ⭐⭐ | 需先转 docx |

## 🔗 工作流集成

### 前置条件
- 用户准备好参考论文文档
- 工具依赖已安装

### 触发时机
在 **Workflow 04** 中选择模式D时：
```
用户选择模式D
    ↓
检查 reference-papers/ 目录
    ↓
[有 Word/PDF 文件] → 执行 Workflow 04.3 (本工作流)
    ↓
[转换完成] → 执行 Workflow 04.5
    ↓
继续后续工作流
```

### 后续工作流
- **Workflow 04.5**: 参考论文结构解析
- **Workflow 05**: 基于大纲预填内容计划（应用参考规则）
- **Workflow 07**: 智能内容生成（应用参考风格）

## 🎯 质量保证

### 转换质量指标

**优秀** (90分以上):
- ✅ 所有标题层级正确
- ✅ 图片全部提取且引用正确
- ✅ 表格格式保留完整
- ✅ 无明显乱码或格式错误

**良好** (70-90分):
- ✅ 主要标题层级正确
- ⚠️ 部分图片缺失或错位
- ⚠️ 复杂表格略有变形
- ✅ 整体可读性良好

**可用** (60-70分):
- ✅ 基本结构可识别
- ⚠️ 需要人工修正部分内容
- ⚠️ 图片和表格问题较多
- ⚠️ 建议使用更好的源文档

**不可用** (60分以下):
- ❌ 结构混乱无法识别
- ❌ 大量内容丢失
- ❌ 建议更换源文档格式

### 常见问题处理

#### Q1: 转换后标题层级错乱
**原因**: 原文档使用了自定义样式而非标准标题样式
**解决**:
1. 在 Word 中将标题应用标准样式（标题1、标题2等）
2. 重新保存后再转换

#### Q2: 图片无法提取
**原因**: 图片可能是嵌入对象或特殊格式
**解决**:
1. 在 Word 中右键图片 → 另存为 → PNG
2. 手动放入 `_images/` 目录
3. 在 MD 中添加引用: `![图片说明](郭正云_images/图片名.png)`

#### Q3: 表格格式混乱
**原因**: Markdown 表格对复杂格式支持有限
**解决**:
1. 简化表格（去掉合并单元格、复杂边框）
2. 或接受表格的简化版本（影响不大）

#### Q4: PDF 转换质量差
**原因**: 扫描版 PDF 或图片型 PDF
**解决**:
1. 尝试获取 Word 原件
2. 或使用 OCR 工具先识别文字
3. 最后考虑手动整理关键部分

## 💡 使用建议

### 1. 推荐的参考论文格式
```
最佳: .docx (Office 2010+)
    ↓
可用: .doc (Office 2003)
    ↓
备选: PDF (文字型，非扫描版)
```

### 2. 提前准备
```bash
# 建议在执行 Workflow 01 之前准备好参考论文
# 这样在执行到 Workflow 04 时可以直接使用

mkdir -p reference-papers
# 放入参考论文.docx
```

### 3. 批量转换
```bash
# 如果有多篇参考论文
for file in reference-papers/*.docx; do
    python3 tools/word-to-md-complete.py "$file"
done
```

### 4. 转换后检查
```bash
# 快速查看转换结果
head -n 50 reference-papers/郭正云.md

# 检查图片数量
ls -l reference-papers/郭正云_images/ | wc -l

# 查看 MD 文件大小
du -h reference-papers/*.md
```

## 📈 性能指标

| 文档大小 | 页数 | 图片数 | 预计耗时 |
|---------|-----|-------|---------|
| < 1 MB | < 20 | < 10 | 10-30秒 |
| 1-5 MB | 20-50 | 10-30 | 30-60秒 |
| 5-10 MB | 50-100 | 30-50 | 1-3分钟 |
| > 10 MB | > 100 | > 50 | 3-5分钟 |

## 🚀 未来优化方向

### P1 功能增强
- ⏳ 支持批量转换多个文档
- ⏳ 转换质量自动评分
- ⏳ 增量转换（只转换修改部分）

### P2 格式支持
- ⏳ LaTeX 公式识别和保留
- ⏳ 页眉页脚选择性保留
- ⏳ 脚注和尾注处理

### P3 用户体验
- ⏳ 转换进度实时显示
- ⏳ 转换前后对比预览
- ⏳ 一键修复常见问题

---

**最后更新**: 2025-09-30
**依赖工具**: word-to-md-complete.py
**后续工作流**: 04.5 参考论文结构解析
**相关文档**: README-参考论文集成.md