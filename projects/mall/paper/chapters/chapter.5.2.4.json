{
  "id": "5.2.4",
  "title": "购物车模块实现",
  "word_limit": 500,
  "text": "placeholder",
  "imagePath": "${impl}/impl-cart.png",
  "_note": "三级章节，必须有text，包含实现截图",
  "content": "购物车模块采用Redis作为主存储，MySQL作为备份存储的双写策略，保证高性能和数据可靠性。模块实现效果如图5-4所示。\n\n数据库设计方面，购物车表cart包含id、user_id、product_id、quantity、checked、create_time、update_time等字段。checked字段标识商品是否选中，结算时只处理选中的商品。建立user_id和product_id的联合唯一索引，防止同一用户重复添加相同商品。\n\nRedis存储设计采用Hash数据结构。Key格式为cart:userId，field为productId，value为JSON字符串包含商品信息和数量。这种设计支持快速的增删改查操作，获取用户整个购物车只需一次HGETALL命令，修改单个商品数量使用HSET命令。设置购物车过期时间为7天，使用EXPIRE命令刷新过期时间。\n\nService层实现购物车业务逻辑。添加商品到购物车方法首先从Redis获取购物车数据，使用redisTemplate.opsForHash().get()方法。如果商品已存在，数量累加；如果是新商品，添加到购物车。调用商品服务获取商品最新价格和库存，验证库存充足。更新Redis中的购物车数据，使用HSET命令。异步写入MySQL数据库，保证数据持久化。计算购物车总价返回给前端。\n\n修改商品数量方法验证新数量的合法性，数量必须大于0且不超过库存。更新Redis中的商品数量，同步更新MySQL。如果数量改为0，等同于删除商品，使用HDEL命令从Redis中删除，同时删除数据库记录。删除商品方法直接从Redis和MySQL中删除对应记录。清空购物车方法使用DEL命令删除整个购物车Key，批量删除数据库记录。\n\n查询购物车方法从Redis获取购物车数据，如果Redis中不存在，从MySQL加载并写入Redis。遍历购物车商品，调用商品服务批量查询商品最新信息，包括价格、库存、商品状态。商品已下架或库存不足时标记该商品，前端显示相应提示。计算选中商品的总价，包括商品小计和购物车合计。购物车列表按添加时间倒序排列返回。\n\n选中状态管理方法更新商品的checked字段。全选方法将所有商品的checked设置为true，全不选设置为false。单个商品的选中切换修改对应商品的checked值。Redis和MySQL同步更新选中状态。\n\n购物车合并处理用户登录场景。用户未登录时，购物车数据存储在浏览器LocalStorage中。用户登录后，前端将本地购物车数据提交给后端。后端从Redis获取用户原有购物车，遍历本地购物车商品，如果商品已存在则数量累加，如果是新商品则添加到购物车。合并完成后返回最新的购物车数据给前端，前端清空本地购物车。\n\nController层提供购物车操作接口。添加商品接口POST /api/cart接收productId和quantity参数。购物车列表接口GET /api/cart返回用户购物车数据。修改数量接口PUT /api/cart/{productId}接收新数量。删除商品接口DELETE /api/cart/{productId}删除指定商品。清空购物车接口DELETE /api/cart/clear清空所有商品。选中接口PUT /api/cart/{productId}/check切换商品选中状态。购物车模块通过Redis缓存提供了高性能的购物车操作体验。"
}