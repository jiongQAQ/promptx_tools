{
  "id": "5.3",
  "title": "微服务治理与基础设施实现",
  "word_limit": 900,
  "text": "placeholder",
  "_note": "二级章节，无子节点，需要text，包含配置示例",
  "content": "微服务治理的实现依托Spring Cloud Alibaba提供的核心组件，通过合理的配置和编码实现服务注册与发现、配置管理、流量控制、熔断降级等关键功能。\n\nNacos服务注册与发现的实现在每个微服务的配置文件中完成。在bootstrap.yml中配置Nacos服务器地址和应用名称。spring.cloud.nacos.discovery.server-addr配置Nacos地址，spring.application.name配置服务名称。服务启动时，Spring Cloud自动完成服务注册，无需编写额外代码。服务调用通过OpenFeign实现，定义Feign客户端接口，使用@FeignClient注解指定目标服务名称。接口方法使用@GetMapping、@PostMapping等注解定义请求路径和参数。Feign客户端自动从Nacos获取服务实例列表，使用Ribbon进行负载均衡，选择一个实例发起调用。Ribbon的负载均衡策略可以配置，默认使用轮询策略，也可以配置为随机、加权响应时间等策略。\n\nNacos配置中心的实现同样通过配置文件完成。bootstrap.yml中配置spring.cloud.nacos.config.server-addr和spring.cloud.nacos.config.file-extension，指定配置中心地址和配置文件格式。在Nacos控制台创建配置，配置ID为服务名称+环境，如mall-user-dev.yml。配置内容包括数据库连接、Redis连接、日志级别等。服务启动时从Nacos加载配置，合并到Spring的Environment中。配置动态刷新通过@RefreshScope注解实现，在需要动态刷新的Bean上添加此注解，Nacos配置更新后，Spring自动重新创建Bean实例，加载新配置。配置管理通过命名空间实现环境隔离，在Nacos创建dev、test、prod命名空间，不同环境的配置互不干扰。\n\nSentinel流量控制的实现需要引入Sentinel依赖，在配置文件中配置Sentinel Dashboard地址。使用@SentinelResource注解标注需要保护的方法，value属性指定资源名称，blockHandler属性指定限流时的降级方法。限流规则在Sentinel Dashboard配置，设置资源名称、限流阈值、限流模式等。规则持久化到Nacos，避免Sentinel重启后规则丢失。熔断降级规则同样在Dashboard配置，设置慢调用比例、异常比例、异常数等熔断条件。当条件触发时，Sentinel熔断该资源的调用，执行降级方法返回默认值。降级方法的实现遵循方法签名一致原则，参数列表相同，增加BlockException参数。降级方法中记录降级日志，返回友好的错误提示或缓存数据。\n\nSeata分布式事务的实现需要配置Seata客户端和服务端。客户端配置file.conf指定事务分组，registry.conf指定注册中心为Nacos。在需要分布式事务的方法上添加@GlobalTransactional注解，Seata自动开启全局事务。方法内部调用其他服务的接口，这些调用自动注册为分布式事务的分支。所有分支执行成功，全局事务提交；任何分支失败，全局事务回滚，Seata通过undo log自动回滚各分支的数据变更。数据库需要创建undo_log表存储回滚日志。Seata支持AT、TCC、SAGA等多种事务模式，本系统主要使用AT模式，对业务代码侵入性最小。\n\nAPI网关使用Spring Cloud Gateway实现。创建独立的网关服务，配置路由规则。在application.yml中定义routes，每个路由包含id、uri、predicates、filters等配置。uri指定目标服务，支持lb://service-name格式自动从Nacos获取服务实例。predicates定义路由匹配条件，如Path=/api/user/**匹配所有用户服务的请求。filters定义过滤器，如StripPrefix=1去除路径前缀。自定义过滤器实现JWT认证，继承AbstractGatewayFilterFactory，在apply方法中解析JWT token，验证有效性，提取用户信息传递给下游服务。全局过滤器实现统一的异常处理、日志记录、跨域配置等功能。网关启动类添加@EnableDiscoveryClient注解，向Nacos注册网关服务。\n\n微服务监控采用Spring Boot Actuator和Prometheus。每个微服务引入Actuator依赖，暴露健康检查、指标采集等端点。Prometheus定时从Actuator端点采集指标数据，存储时间序列数据。Grafana连接Prometheus数据源，配置监控面板，展示QPS、响应时间、错误率、JVM内存等关键指标，实现系统运行状态的实时监控。告警规则在Prometheus配置，当指标异常时触发告警，通过邮件或短信通知运维人员。\n\n日志采集使用ELK（Elasticsearch + Logstash + Kibana）方案。微服务使用Logback输出日志，配置日志格式包含时间戳、日志级别、线程名、类名、日志内容等。日志输出到文件，Filebeat采集日志文件发送到Logstash。Logstash进行日志解析和格式转换，输出到Elasticsearch。Kibana连接Elasticsearch，提供日志查询和可视化界面。通过Kibana可以快速定位问题，分析系统运行情况。链路追踪使用Sleuth和Zipkin，为每个请求生成唯一的Trace ID，记录请求在各个服务间的调用链路和耗时，帮助定位性能瓶颈。"
}