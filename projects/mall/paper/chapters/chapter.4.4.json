{
  "id": "4.4",
  "title": "微服务治理与基础设施设计",
  "word_limit": 1200,
  "text": "placeholder",
  "imagePath": "${uml}/microservice-governance.png",
  "_note": "二级章节，无子节点，重要章节，包含治理架构图",
  "content": "微服务治理是微服务架构的核心环节，通过完善的基础设施保障系统的高可用性和稳定运行。本系统的微服务治理架构如图4-11所示，主要包括服务注册与发现、配置管理、流量控制、熔断降级、分布式事务等关键功能。\n\n服务注册与发现采用Nacos实现。Nacos作为服务注册中心，提供了服务的动态注册和健康检查机制。每个微服务启动时，通过配置文件指定Nacos服务器地址，自动向Nacos注册服务信息，包括服务名称、IP地址、端口号等。Nacos为每个服务实例提供健康检查，定期探测服务实例的存活状态，如果检测到服务实例不可用，自动将其从服务列表中剔除，避免将请求路由到故障实例。服务发现通过Nacos客户端实现，服务调用方从Nacos获取目标服务的实例列表，使用负载均衡算法选择一个实例进行调用。Nacos支持服务的动态上下线，新增服务实例能够被自动发现，下线服务实例及时从列表中移除，保证服务列表的实时性和准确性。Nacos还支持服务分组和命名空间，可以按环境（开发、测试、生产）或业务域对服务进行隔离，避免不同环境的服务相互干扰。\n\n配置管理同样由Nacos提供。传统的配置文件管理方式存在配置分散、更新困难的问题，特别是在微服务架构下，每个服务都有独立的配置文件，修改配置需要重新打包部署，非常不便。Nacos配置中心提供了集中化的配置管理方案，所有服务的配置统一存储在Nacos中，通过配置ID和分组进行管理。服务启动时从Nacos加载配置，配置以Key-Value形式存储，支持多种配置格式如Properties、YAML、JSON等。Nacos支持配置的动态更新，管理员在控制台修改配置后，服务能够实时感知配置变化并重新加载，无需重启服务。这一特性对于调整系统参数、切换功能开关等场景非常有用。配置管理还支持配置的版本管理和灰度发布，可以回滚到历史版本，降低配置变更的风险。\n\nAPI网关采用Spring Cloud Gateway实现，作为系统的统一入口。网关承担了请求路由、负载均衡、权限认证、限流控制等多项职责。请求路由根据请求路径将请求转发到相应的微服务，路由规则在网关配置文件中定义，支持基于路径、Header、参数等多种路由匹配方式。负载均衡在服务有多个实例时，网关根据负载均衡策略（如轮询、随机、加权）选择一个实例进行转发，实现流量的均匀分配。权限认证通过网关过滤器实现，网关解析请求Header中的JWT令牌，验证令牌的有效性和用户权限，未登录或权限不足的请求直接返回错误，不会到达后端服务。限流控制通过令牌桶算法实现，控制单位时间内的请求数量，防止恶意请求和流量攻击。网关还集成了跨域配置、请求日志、异常处理等功能，提供了完善的网关治理能力。\n\n流量控制和熔断降级由Sentinel组件提供。Sentinel以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。流量控制通过设置QPS阈值限制接口的访问频率，当请求量超过阈值时，后续请求被拒绝或排队等待，保护服务不被流量洪峰压垮。Sentinel支持多种流控模式，包括直接拒绝、慢启动预热、匀速排队等，可以根据业务场景选择合适的模式。熔断降级是服务容错的重要手段，当调用的下游服务响应时间过长或异常率过高时，Sentinel自动熔断该服务的调用，快速失败并返回降级响应，避免故障扩散。熔断器有开启、关闭、半开三种状态，熔断开启后，经过一段时间会进入半开状态，尝试恢复调用，如果调用成功则关闭熔断器，否则继续保持熔断。系统负载保护根据系统的CPU使用率、线程数、响应时间等指标进行自适应流控，当系统负载过高时自动降低流量，保护系统不被压垮。Sentinel提供了实时监控界面，可以查看每个接口的QPS、响应时间、异常率等指标，直观地了解系统运行状态。\n\n分布式事务采用Seata解决。在微服务架构下，一个业务操作可能涉及多个服务的数据变更，如订单创建需要扣减库存、创建订单、清空购物车等操作，这些操作分布在不同的服务和数据库中，需要保证数据的一致性。Seata提供了AT、TCC、SAGA等多种事务模式。本系统主要采用AT模式，这是一种无侵入的分布式事务解决方案。AT模式的原理是在业务SQL执行前后，Seata自动生成undo log，记录数据的前后镜像。事务提交时，如果所有分支事务都成功，则提交全局事务；如果有分支失败，则通过undo log回滚数据。Seata由三个组件组成：TC（Transaction Coordinator）事务协调器，维护全局事务和分支事务的状态；TM（Transaction Manager）事务管理器，定义全局事务的边界；RM（Resource Manager）资源管理器，管理分支事务的资源。使用Seata时，只需在业务方法上添加@GlobalTransactional注解，Seata即可自动管理分布式事务，对业务代码的侵入性极小。"
}