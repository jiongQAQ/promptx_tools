{
  "id": "5.3.3",
  "title": "订单管理模块实现",
  "word_limit": 600,
  "text": "placeholder",
  "imagePath": "${impl}/impl-order.png",
  "_note": "三级章节，必须有text，包含实现截图",
  "content": "订单管理模块是电商系统最复杂的业务模块，涉及多个服务的协调和分布式事务的处理。模块实现效果如图5-3所示。\n\n数据库设计方面，订单主表orders包含id、order_no（订单编号）、user_id、total_amount（订单总金额）、status（订单状态）、receiver_name、receiver_phone、receiver_address、pay_time、ship_time、create_time等字段。order_no使用雪花算法生成，保证全局唯一且有序。订单详情表order_item包含id、order_id、product_id、product_name、price、quantity、amount等字段，一个订单对应多个订单详情记录。订单状态流转记录表order_status_log记录订单状态的每次变更，包括变更时间、变更前状态、变更后状态、操作人等信息，实现订单状态的可追溯。\n\n订单创建是订单模块的核心功能，实现复杂的分布式事务处理。方法上添加@GlobalTransactional注解开启Seata分布式事务。首先验证用户登录状态和收货地址。调用购物车服务获取用户选中的商品列表，计算订单总金额。调用商品服务批量检查库存，使用OpenFeign客户端调用商品服务的接口，传入商品ID列表，商品服务返回每个商品的库存状态。如果有商品库存不足，抛出业务异常，事务回滚。库存充足时，调用商品服务预扣减库存，商品服务将available_stock减少，locked_stock增加，库存预扣减成功返回。生成订单编号，创建订单主表记录，状态设置为待支付。批量创建订单详情记录。调用购物车服务清空已结算的商品。所有操作都在同一个全局事务中，任何一步失败都会触发Seata的分布式事务回滚，保证数据一致性。\n\n订单支付处理集成第三方支付平台。用户选择支付方式后，系统生成支付请求，调用支付平台的API创建支付订单，获取支付二维码或支付链接返回给前端。用户完成支付后，支付平台通过回调接口通知系统支付结果。回调接口首先验证签名，确保请求来自支付平台。解析回调参数，获取订单号和支付金额。根据订单号查询订单，验证订单状态为待支付，验证支付金额与订单金额一致。验证通过后，更新订单状态为已支付，记录支付时间。调用商品服务真正扣减库存，将locked_stock减少。发送订单支付成功的消息到消息队列，由消费者异步发送短信和邮件通知用户。\n\n订单超时处理通过定时任务实现。使用@Scheduled注解配置定时任务，每分钟执行一次。查询所有待支付状态且创建时间超过30分钟的订单，批量取消订单。更新订单状态为已取消。调用商品服务释放预扣减的库存，将locked_stock减少，available_stock增加。定时任务使用分布式锁保证只有一个实例执行，避免重复处理。\n\n订单状态管理实现状态机模式。定义订单状态枚举和状态流转规则。状态变更方法首先验证当前状态是否允许变更到目标状态，不允许的状态流转抛出业务异常。允许的流转更新订单状态，记录状态变更日志。订单发货方法验证订单状态为已支付，更新状态为已发货，记录物流信息。订单确认收货方法验证状态为已发货，更新状态为已完成，记录完成时间。订单取消方法根据当前状态执行不同逻辑，待支付订单直接取消并释放库存，已支付订单需要申请退款。\n\nController层提供订单相关接口。创建订单接口POST /api/order/create接收订单信息，调用orderService.create()方法返回订单编号。订单列表接口GET /api/order/list支持按状态筛选和分页查询。订单详情接口GET /api/order/{id}返回订单的完整信息包括订单详情列表。取消订单接口PUT /api/order/{id}/cancel验证用户权限后取消订单。订单管理模块通过完善的实现，保证了订单处理的准确性和数据一致性。"
}