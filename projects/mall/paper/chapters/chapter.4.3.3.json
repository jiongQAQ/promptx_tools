{
  "id": "4.3.3",
  "title": "订单管理模块设计",
  "word_limit": 500,
  "text": "placeholder",
  "imagePath": "${uml}/activity-order.png",
  "imagePathSequence": "${uml}/sequence-order.png",
  "_note": "三级章节,必须有text,包含活动图和时序图",
  "content": "订单管理模块是系统的核心业务模块,为用户提供订单创建、订单支付、状态管理、订单查询等功能。订单业务流程如图4-5所示,服务间协作时序如图4-6所示。",
  "code": "/**\n * 生成订单方法\n * 通过OpenFeign调用购物车服务和商品服务完成订单创建\n */\n@Override\n@Transactional\npublic String saveOrder(Long userId, MallUserAddress userAddress, List<Long> cartItemIds) {\n    // 通过Feign调用购物车服务获取购物项列表\n    List<NewBeeMallShoppingCartItemVO> itemsForSave = new ArrayList<>();\n    Result<List<NewBeeMallShoppingCartItemVO>> cartItemResult = \n        newBeeMallShopCartServiceFeign.listByCartItemIds(cartItemIds);\n    if (cartItemResult == null || cartItemResult.getResultCode() != 200 \n        || CollectionUtils.isEmpty(cartItemResult.getData())) {\n        NewBeeMallException.fail(ServiceResultEnum.SHOPPING_ITEM_ERROR.getResult());\n    }\n    itemsForSave = cartItemResult.getData();\n    \n    // 构建商品ID列表,通过Feign调用商品服务获取商品详情\n    List<Long> goodsIds = itemsForSave.stream().map(NewBeeMallShoppingCartItemVO::getGoodsId)\n        .collect(Collectors.toList());\n    Result<List<NewBeeMallGoodsDTO>> goodsResult = \n        newBeeMallGoodsServiceFeign.listByGoodsIds(goodsIds);\n    if (goodsResult == null || goodsResult.getResultCode() != 200) {\n        NewBeeMallException.fail(ServiceResultEnum.GOODS_NOT_EXIST.getResult());\n    }\n    \n    // 判断商品库存\n    Map<Long, NewBeeMallGoodsDTO> newBeeMallGoodsMap = new HashMap<>();\n    List<NewBeeMallGoodsDTO> newBeeMallGoods = goodsResult.getData();\n    for (NewBeeMallGoodsDTO goods : newBeeMallGoods) {\n        newBeeMallGoodsMap.put(goods.getGoodsId(), goods);\n    }\n    // 判断商品库存并计算订单价格\n    for (NewBeeMallShoppingCartItemVO shoppingCartItemVO : itemsForSave) {\n        if (!newBeeMallGoodsMap.containsKey(shoppingCartItemVO.getGoodsId())) {\n            NewBeeMallException.fail(ServiceResultEnum.GOODS_NOT_EXIST.getResult());\n        }\n        if (shoppingCartItemVO.getGoodsCount() > \n            newBeeMallGoodsMap.get(shoppingCartItemVO.getGoodsId()).getStockNum()) {\n            NewBeeMallException.fail(ServiceResultEnum.GOODS_STOCK_ERROR.getResult());\n        }\n    }\n    \n    // 删除购物项\n    if (!CollectionUtils.isEmpty(itemsForSave) && !CollectionUtils.isEmpty(cartItemIds)\n        && itemsForSave.size() == cartItemIds.size()) {\n        newBeeMallShopCartServiceFeign.deleteBatch(cartItemIds);\n    } else {\n        NewBeeMallException.fail(ServiceResultEnum.SHOPPING_ITEM_COUNT_ERROR.getResult());\n    }\n    \n    // 保存订单并返回订单号\n    NewBeeMallOrder newBeeMallOrder = new NewBeeMallOrder();\n    newBeeMallOrder.setUserId(userId);\n    newBeeMallOrder.setUserAddress(userAddress.getUserAddress());\n    // ... 设置其他订单信息\n    if (newBeeMallOrderMapper.insertSelective(newBeeMallOrder) > 0) {\n        // 通过Feign调用商品服务扣减库存\n        List<StockNumDTO> stockNumDTOS = BeanUtil.copyList(orderItems, StockNumDTO.class);\n        Result<Boolean> updateStockResult = \n            newBeeMallGoodsServiceFeign.updateStock(stockNumDTOS);\n        if (updateStockResult == null || updateStockResult.getResultCode() != 200 \n            || !updateStockResult.getData()) {\n            NewBeeMallException.fail(ServiceResultEnum.GOODS_STOCK_ERROR.getResult());\n        }\n        return newBeeMallOrder.getOrderNo();\n    }\n    NewBeeMallException.fail(ServiceResultEnum.DB_ERROR.getResult());\n    return ServiceResultEnum.DB_ERROR.getResult();\n}"
}