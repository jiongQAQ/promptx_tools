{
  "id": "5.2.2",
  "title": "商品管理模块实现",
  "word_limit": 600,
  "text": "placeholder",
  "imagePath": "${impl}/impl-goods.png",
  "_note": "三级章节，必须有text，包含实现截图",
  "content": "商品管理模块实现了商品信息的全生命周期管理，包括商品的增删改查、分类管理、库存管理等功能。模块实现效果如图5-2所示。\n\n数据库设计方面，商品表product包含id、name、description、price、stock、category_id、image_url、status、sales、create_time、update_time等字段。category_id关联商品分类表，image_url存储商品图片的URL地址，status字段标识商品状态（0下架，1上架），sales记录销量。商品分类表category采用树形结构，包含id、name、parent_id、level、sort等字段，通过parent_id构建分类层次。库存表stock单独维护，包含product_id、available_stock（可用库存）、locked_stock（锁定库存）等字段，支持库存的预扣减和释放。\n\n实体类Product使用Lombok注解，@TableName(\"product\")指定表名，字段与数据库字段一一对应。Category类包含分类信息，通过递归方法构建分类树。DTO类ProductDTO用于接收前端提交的商品信息，VO类ProductVO用于返回给前端的商品信息，包含分类名称等关联数据。\n\nMapper层ProductMapper继承BaseMapper<Product>，提供基础CRUD方法。自定义方法通过XML映射文件编写复杂SQL。商品列表查询支持多条件筛选，使用动态SQL根据参数动态拼接WHERE条件。分页查询使用MyBatis-Plus的Page对象，传入当前页码和每页数量，自动完成分页。库存扣减方法使用乐观锁机制，UPDATE语句中增加WHERE available_stock >= #{quantity}条件，防止库存超卖。SQL返回影响行数，如果为0表示库存不足，抛出库存不足异常。\n\nService层实现核心业务逻辑。商品添加方法接收商品信息，验证必填字段，调用OSS服务上传商品图片，获取图片URL存入数据库。设置商品初始状态为下架，需要管理员审核后上架。商品修改方法根据商品ID查询商品，验证商品所属权限，更新商品信息。如果上传了新图片，删除旧图片并上传新图片。商品删除采用逻辑删除，设置deleted字段为1，保留商品历史记录。商品查询方法根据查询条件构建QueryWrapper，调用mapper的selectPage方法获取分页数据。将Product对象转换为ProductVO对象，填充分类名称等关联信息返回。\n\n缓存优化是商品模块的重点。商品详情查询采用缓存穿透、击穿、雪崩的防护策略。查询流程：先查Redis缓存，缓存命中直接返回；缓存未命中查询数据库，如果数据库中也不存在，缓存空对象设置较短过期时间防止缓存穿透；如果数据库中存在，将数据写入Redis设置合理过期时间返回。热点商品使用互斥锁防止缓存击穿，当缓存失效时，只允许一个请求查询数据库并更新缓存，其他请求等待。缓存雪崩通过设置随机过期时间避免，基础过期时间加上随机值，避免大量缓存同时失效。商品列表查询也使用缓存，将查询条件作为缓存key的一部分，实现细粒度缓存。\n\n分类管理实现方面，查询分类树方法从数据库查询所有分类，在内存中构建树形结构。使用递归算法，从根节点开始，找出所有子节点，子节点继续递归查找。最终返回完整的分类树。添加分类时验证父分类是否存在，计算分类层级。修改和删除分类时检查是否有子分类或关联商品，有则不允许删除，提示先处理子分类和商品。\n\nController层提供完整的RESTful API。管理员接口需要管理员权限，使用@PreAuthorize(\"hasRole('ADMIN')\")注解进行权限控制。用户接口提供商品查询、搜索功能，不需要权限即可访问。商品搜索接口支持关键词搜索，在商品名称和描述中进行模糊匹配，使用LIKE %keyword%语句实现。搜索结果按相关度和销量排序。商品管理模块通过完善的实现，支撑了电商平台的商品展示和管理需求。"
}