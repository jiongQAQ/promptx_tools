@startuml sequence-recommend

title 首页推荐模块服务交互

actor "用户" as User
participant "Gateway" as Gateway
participant "推荐服务\n(Recommend Service)" as RecommendService
participant "商品服务\n(Goods Service)" as GoodsService
database "Redis" as Redis
database "MySQL\n(推荐库)" as RecommendDB

== 首页热门推荐 ==

User -> Gateway: GET /api/recommend/hot
activate Gateway

Gateway -> RecommendService: 转发请求
activate RecommendService

RecommendService -> Redis: GET recommend:hot:goods
activate Redis

alt 缓存命中
  Redis --> RecommendService: 推荐列表
  RecommendService --> Gateway: 返回推荐
  Gateway --> User: 200 OK

else 缓存未命中
  Redis --> RecommendService: null
  deactivate Redis

  RecommendService -> RecommendDB: SELECT goodsId,\n  (saleCount*0.5 + viewCount*0.3 + collectCount*0.2) as score\nFROM tb_goods_stats\nORDER BY score DESC\nLIMIT 20
  activate RecommendDB
  RecommendDB --> RecommendService: 商品ID列表
  deactivate RecommendDB

  RecommendService -> GoodsService: POST /internal/goods/batch-info\n{goodsIds}
  activate GoodsService
  GoodsService --> RecommendService: 商品详细信息
  deactivate GoodsService

  RecommendService -> Redis: SET recommend:hot:goods\nEXPIRE 3600
  activate Redis
  Redis --> RecommendService: OK
  deactivate Redis

  RecommendService --> Gateway: 返回推荐
  deactivate RecommendService
  Gateway --> User: 200 OK
  deactivate Gateway
end

== 个性化推荐 ==

User -> Gateway: GET /api/recommend/personal\nHeader: Authorization
activate Gateway

Gateway -> Gateway: 解析JWT获取userId

Gateway -> RecommendService: 转发请求 {userId}
activate RecommendService

RecommendService -> Redis: GET recommend:personal:{userId}
activate Redis

alt 缓存命中
  Redis --> RecommendService: 个性化推荐
  RecommendService --> Gateway: 返回推荐
  Gateway --> User: 200 OK

else 缓存未命中
  Redis --> RecommendService: null
  deactivate Redis

  RecommendService -> RecommendDB: SELECT * FROM tb_user_behavior\nWHERE userId=?
  activate RecommendDB
  RecommendDB --> RecommendService: 用户行为数据\n(浏览、购买、收藏)
  deactivate RecommendDB

  RecommendService -> RecommendService: 分析用户兴趣\n计算推荐商品

  RecommendService -> GoodsService: POST /internal/goods/similar\n{goodsIds: [已浏览商品]}
  activate GoodsService
  GoodsService --> RecommendService: 相似商品列表
  deactivate GoodsService

  RecommendService -> RecommendService: 合并去重\n排序推荐结果

  RecommendService -> Redis: SET recommend:personal:{userId}\nEXPIRE 86400
  activate Redis
  Redis --> RecommendService: OK
  deactivate Redis

  RecommendService --> Gateway: 返回个性化推荐
  deactivate RecommendService
  Gateway --> User: 200 OK
  deactivate Gateway
end

== 首页轮播图配置 ==

User -> Gateway: GET /api/recommend/carousel
activate Gateway

Gateway -> RecommendService: 转发请求
activate RecommendService

RecommendService -> Redis: GET recommend:carousel
activate Redis

alt 缓存命中
  Redis --> RecommendService: 轮播图列表
  RecommendService --> Gateway: 返回轮播图
  Gateway --> User: 200 OK

else 缓存未命中
  Redis --> RecommendService: null
  deactivate Redis

  RecommendService -> RecommendDB: SELECT * FROM tb_carousel\nWHERE isDeleted=0\nORDER BY carouselRank ASC
  activate RecommendDB
  RecommendDB --> RecommendService: 轮播图数据
  deactivate RecommendDB

  RecommendService -> Redis: SET recommend:carousel\nEXPIRE 7200
  activate Redis
  Redis --> RecommendService: OK
  deactivate Redis

  RecommendService --> Gateway: 返回轮播图
  deactivate RecommendService
  Gateway --> User: 200 OK
  deactivate Gateway
end

== 定时任务更新推荐缓存 ==

participant "定时任务" as Scheduler

Scheduler -> RecommendService: 触发推荐计算任务
activate RecommendService

RecommendService -> RecommendDB: 查询商品统计数据
activate RecommendDB
RecommendDB --> RecommendService: 统计数据
deactivate RecommendDB

RecommendService -> RecommendService: 计算热门推荐
RecommendService -> RecommendService: 计算新品推荐

RecommendService -> GoodsService: 批量获取商品信息
activate GoodsService
GoodsService --> RecommendService: 商品详情
deactivate GoodsService

RecommendService -> Redis: 更新推荐缓存\nSET recommend:hot:goods\nSET recommend:new:goods
activate Redis
Redis --> RecommendService: OK
deactivate Redis

RecommendService --> Scheduler: 更新完成
deactivate RecommendService

@enduml
