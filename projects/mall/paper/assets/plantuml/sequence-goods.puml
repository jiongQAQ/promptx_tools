@startuml sequence-goods

<<<<<<< HEAD
skinparam linetype ortho
skinparam nodesep 100
skinparam ranksep 100
=======
!pragma layout smetana
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80
>>>>>>> 32c2d4b6a4b90edef88800c5b58783d709691097

title 商品管理模块服务间交互

actor "用户" as User
participant "Gateway" as Gateway
participant "商品服务\n(Goods Service)" as GoodsService
database "Redis" as Redis
database "MySQL\n(商品库)" as GoodsDB

== 商品列表查询 ==

User -> Gateway: GET /api/goods/list\n?categoryId=1&page=1
activate Gateway

Gateway -> GoodsService: 转发查询请求
activate GoodsService

GoodsService -> Redis: GET goods:list:category:1:page:1
activate Redis

alt 缓存命中
  Redis --> GoodsService: 商品列表数据
  GoodsService --> Gateway: 返回商品列表

else 缓存未命中
  Redis --> GoodsService: null
  deactivate Redis

  GoodsService -> GoodsDB: SELECT * FROM tb_goods\nWHERE categoryId=1\nLIMIT 0,20
  activate GoodsDB
  GoodsDB --> GoodsService: 商品数据
  deactivate GoodsDB

  GoodsService -> Redis: SET goods:list:category:1:page:1\nEXPIRE 3600
  activate Redis
  Redis --> GoodsService: OK
  deactivate Redis

  GoodsService --> Gateway: 返回商品列表
end

deactivate GoodsService
Gateway --> User: 200 OK
deactivate Gateway

== 商品详情查询 ==

User -> Gateway: GET /api/goods/detail/1001
activate Gateway

Gateway -> GoodsService: 转发详情请求
activate GoodsService

GoodsService -> Redis: GET goods:detail:1001
activate Redis

alt 缓存命中
  Redis --> GoodsService: 商品详情
  GoodsService --> Gateway: 返回详情

else 缓存未命中
  Redis --> GoodsService: null
  deactivate Redis

  GoodsService -> GoodsDB: SELECT * FROM tb_goods\nWHERE goodsId=1001
  activate GoodsDB
  GoodsDB --> GoodsService: 商品数据
  deactivate GoodsDB

  GoodsService -> Redis: SET goods:detail:1001\nEXPIRE 1800
  activate Redis
  Redis --> GoodsService: OK
  deactivate Redis

  GoodsService --> Gateway: 返回详情
end

deactivate GoodsService
Gateway --> User: 200 OK
deactivate Gateway

== 管理员添加商品 ==

User -> Gateway: POST /api/admin/goods\nHeader: Authorization
activate Gateway

Gateway -> Gateway: 验证JWT令牌\n检查管理员权限

Gateway -> GoodsService: 转发添加请求\n{商品信息}
activate GoodsService

GoodsService -> GoodsService: 验证必填字段
GoodsService -> GoodsService: 上传商品图片

GoodsService -> GoodsDB: INSERT INTO tb_goods\nVALUES(...)
activate GoodsDB
GoodsDB --> GoodsService: 插入成功, goodsId=1002
deactivate GoodsDB

GoodsService -> Redis: DEL goods:list:*\n(清空列表缓存)
activate Redis
Redis --> GoodsService: OK
deactivate Redis

GoodsService --> Gateway: 添加成功
deactivate GoodsService
Gateway --> User: 200 OK
deactivate Gateway

== 库存扣减(订单调用) ==

participant "订单服务" as OrderService

OrderService -> GoodsService: 检查并扣减库存\nPOST /internal/goods/deduct\n{goodsId, quantity}
activate GoodsService

GoodsService -> Redis: LOCK goods:stock:lock:1001
activate Redis
Redis --> GoodsService: 获取锁成功
deactivate Redis

GoodsService -> GoodsDB: SELECT stockNum\nFROM tb_goods\nWHERE goodsId=1001\nFOR UPDATE
activate GoodsDB
GoodsDB --> GoodsService: stockNum=100
deactivate GoodsDB

alt 库存充足
  GoodsService -> GoodsDB: UPDATE tb_goods\nSET stockNum=stockNum-1\nWHERE goodsId=1001
  activate GoodsDB
  GoodsDB --> GoodsService: 更新成功
  deactivate GoodsDB

  GoodsService -> Redis: DEL goods:detail:1001
  activate Redis
  Redis --> GoodsService: OK
  deactivate Redis

  GoodsService -> Redis: UNLOCK goods:stock:lock:1001
  activate Redis
  Redis --> GoodsService: 释放锁
  deactivate Redis

  GoodsService --> OrderService: 扣减成功

else 库存不足
  GoodsService -> Redis: UNLOCK goods:stock:lock:1001
  GoodsService --> OrderService: 库存不足
end

deactivate GoodsService

@enduml
