@startuml activity-order

<<<<<<< HEAD
skinparam linetype ortho
skinparam nodesep 100
skinparam ranksep 100
=======
!pragma layout smetana
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80
>>>>>>> 32c2d4b6a4b90edef88800c5b58783d709691097

title 订单管理模块业务流程

|用户|
start
:选择商品结算;

|系统|
:验证用户登录;

|用户|
:选择收货地址;

|系统|
:检查商品库存;

if (库存充足?) then (yes)

  :预扣减库存;
  :生成订单编号;
  :创建订单记录;
  :创建订单详情;
  :清空购物车;

  note right
    使用Seata分布式事务
    保证数据一致性
  end note

  |用户|
  :选择支付方式;
  :完成支付;

  |系统|
  :接收支付回调;
  :验证支付签名;

  if (支付成功?) then (yes)
    :更新订单状态为已支付;
    :真正扣减库存;
    :发送支付成功通知;

    |用户|
    :等待发货;

    |管理员|
    :填写物流信息;

    |系统|
    :更新订单状态为已发货;
    :记录物流信息;

    |用户|
    :查看物流;
    :收到货物;

    if (用户操作?) then (确认收货)
      |系统|
      :更新订单状态为已完成;
      :订单完成;
      stop

    else (15天后)
      |系统|
      :自动确认收货;
      :订单完成;
      stop
    endif

  else (支付超时)
    |系统|
    :定时任务检测;
    :取消订单;
    :恢复库存;
    :订单已取消;
    stop
  endif

else (库存不足)
  :返回"库存不足";
  stop
endif

@enduml
