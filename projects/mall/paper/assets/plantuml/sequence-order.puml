@startuml sequence-order


title 订单管理模块服务间协作时序

actor "用户" as User
participant "Gateway" as Gateway
participant "订单服务\n(Order Service)" as OrderService
participant "用户服务\n(User Service)" as UserService
participant "商品服务\n(Goods Service)" as GoodsService
participant "购物车服务\n(Cart Service)" as CartService
participant "Seata TC" as Seata
database "订单库" as OrderDB
queue "RabbitMQ" as MQ

== 订单创建流程 (分布式事务) ==

User -> Gateway: POST /api/order/create\n{goodsId, quantity, addressId}
activate Gateway

Gateway -> Gateway: 验证JWT令牌

Gateway -> OrderService: 转发创建订单请求
activate OrderService

OrderService -> Seata: 开启全局事务\n@GlobalTransactional
activate Seata
Seata --> OrderService: XID=全局事务ID

OrderService -> UserService: GET /internal/user/{userId}
activate UserService
UserService --> OrderService: 用户信息
deactivate UserService

OrderService -> UserService: GET /internal/address/{addressId}
activate UserService
UserService --> OrderService: 收货地址
deactivate UserService

OrderService -> GoodsService: POST /internal/goods/check-stock\n{goodsId, quantity}
activate GoodsService

GoodsService -> GoodsService: 检查库存

alt 库存充足
  GoodsService -> GoodsService: 预扣减库存
  GoodsService --> OrderService: 库存充足, 已预扣

else 库存不足
  GoodsService --> OrderService: 库存不足
  OrderService -> Seata: 回滚全局事务
  Seata --> OrderService: 回滚完成
  OrderService --> Gateway: 库存不足
  Gateway --> User: 400 库存不足
end

deactivate GoodsService

OrderService -> OrderService: 生成订单编号\n(分布式ID)
OrderService -> OrderService: 计算订单金额

OrderService -> OrderDB: INSERT INTO tb_order\nVALUES(...)
activate OrderDB
OrderDB --> OrderService: orderId=10001
deactivate OrderDB

OrderService -> OrderDB: INSERT INTO tb_order_item\nVALUES(...)
activate OrderDB
OrderDB --> OrderService: 插入成功
deactivate OrderDB

OrderService -> CartService: DELETE /internal/cart/clear\n{userId, goodsIds}
activate CartService
CartService --> OrderService: 清空成功
deactivate CartService

OrderService -> Seata: 提交全局事务
Seata -> Seata: 协调各服务提交
Seata --> OrderService: 提交成功
deactivate Seata

OrderService --> Gateway: {orderId, orderNo, totalPrice}
deactivate OrderService

Gateway --> User: 200 OK, 订单创建成功
deactivate Gateway

== 订单支付流程 ==

User -> Gateway: POST /api/order/pay\n{orderId, payType}
activate Gateway

Gateway -> OrderService: 转发支付请求
activate OrderService

OrderService -> OrderDB: SELECT * FROM tb_order\nWHERE orderId=10001
activate OrderDB
OrderDB --> OrderService: 订单信息
deactivate OrderDB

OrderService -> OrderService: 生成支付二维码

OrderService --> Gateway: {payQrCode, payUrl}
deactivate OrderService

Gateway --> User: 支付二维码
deactivate Gateway

... 用户完成支付 ...

participant "支付平台" as PayPlatform

PayPlatform -> Gateway: 支付回调\nPOST /api/order/pay-callback
activate Gateway

Gateway -> OrderService: 转发回调
activate OrderService

OrderService -> OrderService: 验证签名
OrderService -> OrderService: 验证订单金额

OrderService -> OrderDB: UPDATE tb_order\nSET payStatus=1, orderStatus=1\nWHERE orderId=10001
activate OrderDB
OrderDB --> OrderService: 更新成功
deactivate OrderDB

OrderService -> GoodsService: POST /internal/goods/deduct-stock\n{goodsId, quantity}
activate GoodsService
GoodsService -> GoodsService: 真正扣减库存
GoodsService --> OrderService: 扣减成功
deactivate GoodsService

OrderService -> MQ: 发送支付成功消息\n{orderId, userId}
activate MQ
MQ --> OrderService: 消息已发送
deactivate MQ

OrderService --> Gateway: 支付成功
deactivate OrderService

Gateway --> PayPlatform: 200 OK
deactivate Gateway

== 订单发货 ==

actor "管理员" as Admin

Admin -> Gateway: PUT /api/admin/order/ship\n{orderId, logisticsNo}
activate Gateway

Gateway -> OrderService: 转发发货请求
activate OrderService

OrderService -> OrderDB: UPDATE tb_order\nSET orderStatus=3,\nlogisticsNo=?\nWHERE orderId=10001
activate OrderDB
OrderDB --> OrderService: 更新成功
deactivate OrderDB

OrderService -> MQ: 发送发货通知\n{orderId, logisticsNo}
activate MQ
MQ --> OrderService: 消息已发送
deactivate MQ

OrderService --> Gateway: 发货成功
deactivate OrderService

Gateway --> Admin: 200 OK
deactivate Gateway

@enduml
