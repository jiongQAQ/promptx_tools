@startuml high-concurrency-design

!pragma layout smetana
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80

title 系统高并发保障方案

skinparam componentStyle rectangle
skinparam packageStyle rectangle

actor "用户" as User

package "多级缓存架构" {
  component "浏览器缓存\nCache-Control" as BrowserCache
  component "CDN缓存\n静态资源" as CDN
  component "应用缓存\nRedis" as Redis
  database "MySQL\nInnoDB缓冲池" as MySQL

  note right of Redis
    缓存策略:
    • Cache Aside模式
    • 防缓存穿透(空对象)
    • 防缓存击穿(互斥锁)
    • 防缓存雪崩(随机过期)
  end note
}

package "异步处理" {
  queue "RabbitMQ\n消息队列" as MQ
  component "异步处理服务" as AsyncService

  note right of MQ
    优势:
    • 解耦系统组件
    • 削峰填谷
    • 异步提升响应
    • 消息可靠传递
  end note
}

package "数据库优化" {
  component "数据库优化策略" as DBOptimization

  database "MySQL主库\n(写)" as MasterDB
  database "MySQL从库1\n(读)" as SlaveDB1
  database "MySQL从库2\n(读)" as SlaveDB2

  note right of DBOptimization
    优化措施:
    • 高频字段建索引
    • 避免SELECT *
    • 优化分页查询
    • 配置连接池参数
    • 主从复制延迟控制
  end note
}

package "限流降级" {
  component "Spring Cloud Gateway\n网关限流" as GatewayLimit
  component "Sentinel\n服务限流" as SentinelLimit
  component "降级策略" as Degradation

  note right of Degradation
    降级优先级:
    1. 核心: 下单、支付
    2. 重要: 商品查询
    3. 一般: 推荐、评论
  end note
}

package "服务水平扩展" {
  component "微服务集群" as ServiceCluster
  component "负载均衡\nNacos+Ribbon" as LoadBalance
  component "容器化部署\nDocker/K8s" as Container

  note right of Container
    弹性伸缩:
    • 根据负载动态扩容
    • 自动故障恢复
    • 滚动更新部署
  end note
}

package "监控告警" {
  component "监控系统" as Monitor
  component "告警系统" as Alert
}

' 用户访问流程
User --> BrowserCache : 1. 访问
BrowserCache --> CDN : 2. 静态资源
CDN --> GatewayLimit : 3. API请求

GatewayLimit --> LoadBalance : 4. 路由转发
LoadBalance --> ServiceCluster : 5. 负载均衡

ServiceCluster --> Redis : 6. 查询缓存
Redis --> MySQL : 7. 缓存未命中

ServiceCluster --> MQ : 8. 异步消息
MQ --> AsyncService : 9. 异步处理

ServiceCluster .up.> SentinelLimit : 流量控制
SentinelLimit .up.> Degradation : 触发降级

MySQL -up-> MasterDB : 写操作
MySQL -up-> SlaveDB1 : 读操作
MySQL -up-> SlaveDB2 : 读操作

ServiceCluster .down.> Monitor : 指标采集
Monitor --> Alert : 异常触发

Container -up-> ServiceCluster : 弹性伸缩

@enduml
