@startuml microservice-governance

skinparam linetype ortho
skinparam nodesep 100
skinparam ranksep 100

title 微服务治理架构

skinparam componentStyle rectangle
skinparam packageStyle rectangle

package "微服务集群" {
  component [用户服务] as UserService
  component [商品服务] as GoodsService
  component [订单服务] as OrderService
  component [购物车服务] as CartService
  component [推荐服务] as RecommendService
  component [Gateway网关] as Gateway
}

package "服务注册与发现 - Nacos" {
  component "Nacos Server" as Nacos

  note right of Nacos
    功能:
    • 服务动态注册
    • 心跳健康检查
    • 服务实例列表维护
    • 命名空间隔离
    • 服务分组管理
  end note
}

package "配置管理 - Nacos Config" {
  component "Nacos Config Center" as NacosConfig

  note right of NacosConfig
    功能:
    • 集中配置管理
    • 动态配置更新
    • 配置版本控制
    • 灰度发布
    • 配置格式支持(YAML/Properties)
  end note
}

package "流量控制与熔断 - Sentinel" {
  component "Sentinel Dashboard" as Sentinel

  note right of Sentinel
    功能:
    • QPS限流控制
    • 熔断降级保护
    • 慢调用比例熔断
    • 异常比例熔断
    • 实时指标监控
  end note
}

package "分布式事务 - Seata" {
  component "Seata TC" as Seata

  note right of Seata
    模式:
    • AT模式(自动回滚)
    • TCC模式(手动补偿)
    • SAGA模式(长事务)

    功能:
    • 全局事务协调
    • 自动生成undo log
    • 事务状态管理
  end note
}

package "API网关 - Spring Cloud Gateway" {
  component "Gateway功能" as GatewayFeatures

  note right of GatewayFeatures
    功能:
    • 统一入口管理
    • 动态路由配置
    • 权限认证过滤
    • 令牌桶限流
    • 请求日志记录
  end note
}

package "消息队列 - RabbitMQ" {
  component "RabbitMQ" as MQ

  note right of MQ
    功能:
    • 异步消息处理
    • 服务解耦
    • 削峰填谷
    • 消息可靠传递
  end note
}

' 服务注册关系
UserService .up.> Nacos : 注册/心跳
GoodsService .up.> Nacos : 注册/心跳
OrderService .up.> Nacos : 注册/心跳
CartService .up.> Nacos : 注册/心跳
RecommendService .up.> Nacos : 注册/心跳
Gateway .up.> Nacos : 服务发现

' 配置管理关系
UserService .up.> NacosConfig : 加载配置
GoodsService .up.> NacosConfig : 加载配置
OrderService .up.> NacosConfig : 加载配置
CartService .up.> NacosConfig : 加载配置
RecommendService .up.> NacosConfig : 加载配置
Gateway .up.> NacosConfig : 加载配置

' 流量控制关系
Gateway --> Sentinel : 流量控制
UserService .up.> Sentinel : 熔断降级
GoodsService .up.> Sentinel : 熔断降级
OrderService .up.> Sentinel : 熔断降级
CartService .up.> Sentinel : 熔断降级

' 分布式事务关系
OrderService --> Seata : 全局事务\n@GlobalTransactional
GoodsService .down.> Seata : 分支事务(库存扣减)
CartService .down.> Seata : 分支事务(清空购物车)

' 消息队列关系
OrderService --> MQ : 发送订单消息
RecommendService --> MQ : 发送统计消息

' 网关路由关系
Gateway -down-> UserService : 路由
Gateway -down-> GoodsService : 路由
Gateway -down-> OrderService : 路由
Gateway -down-> CartService : 路由
Gateway -down-> RecommendService : 路由

@enduml
