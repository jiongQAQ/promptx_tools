【流程 03｜正文与素材生成（不覆盖原文件｜统一使用 luban-uml）】

目标
1 基于 ./paper/outline.json 与 ./paper/content.json，逐章节生成正文、UML 代码与表格数据。
2 绝不覆盖 ./paper/content.json，改为生成一份新的运行产物：./paper/content.run.json（如已存在则生成 ./paper/content.run.<YYYYMMDD-HHMMSS>.json）。
3 所有 UML 图片由工具 luban-uml 渲染；UML 源码文件与图片文件 **同名**（仅扩展名不同），且**统一保存在同一 uml 目录**下。

输入
- ./paper/outline.json
- ./paper/content.json
- ./source/（与 ./CLAUDE.md，如存在）

目录与命名规范（必须遵守）
- 产物根：./paper/exports/
- UML 目录：./paper/exports/uml/        （UML 源码与图片均放此处）
- 表格目录：./paper/exports/tables/     （三线表 JSON）
- 命名规则：同一图的 UML 源码与图片同名（仅扩展名不同）
  - 基础文件名：Fig-<chapter>-<index>__<slug>
  - slug：来源于 figureTitle 的安全短名（小写，空格→-，去除非法字符，<=60 字符）
  - UML 源码路径：./paper/exports/uml/Fig-<chapter>-<index>__<slug>.puml
  - 图片路径：  ./paper/exports/uml/Fig-<chapter>-<index>__<slug>.png   （或 .svg）
- 表格文件名：Tab-<chapter>-<index>__<slug>.json  → ./paper/exports/tables/

生成规则
1 文本（text）
   - 对 plan.wantText=true 的节点（含 list.items），使用 textPrompt，结合源码/CLAUDE.md 生成正文，写入目标运行产物的相应 node.text。
   - 长度以 length.target 为参考，允许±合理浮动；不做严格硬限制。
   - 保持学术写作风格。

2 图（figures）
   - 对 plan.wantFigure=true 的节点（含 list.items），逐条执行 figurePlan。
   - 仅生成合法且完整的 PlantUML 代码，保存到 .puml，然后**调用 luban-uml 渲染图片**，并将两个路径写回运行产物：
     - figures[i].umlCodePath = "./paper/exports/uml/Fig-<chapter>-<index>__<slug>.puml"
     - figures[i].imagePath   = "./paper/exports/uml/Fig-<chapter>-<index>__<slug>.png"
     - figures[i].status      = "done" | "failed"
   - 渲染命令（示例，务必按“同名不同后缀”落盘；格式自行判断 png/svg）：
     - 写入 UML 源码文件后，调用：
       luban-uml render --in "./paper/exports/uml/Fig-<chapter>-<index>__<slug>.puml" --out "./paper/exports/uml/Fig-<chapter>-<index>__<slug>.png" --format png
     - 成功则记录 stdout 的 JSON 摘要到 figures[i].renderLog，可选。
   - 若任一图失败，保留 .puml，标记 status=failed，并在报告中列出；**失败不阻塞流程**。

⚠️ 数据库设计章节专属要求
   - 如果章节标题包含“数据库设计/数据库概念设计/数据库逻辑设计/ER”：
     1. 必须完整扫描 ./source/，提取全部实体类/表定义（SQL/ORM/实体类），**一个不漏**。
     2. 每个实体生成一个子项，包含：
        - 实体单体结构图（.puml + .png）
        - 实体字段三线表（JSON）
        - 文本描述（业务定位、关键字段、约束、关系）
     3. 在章节级别必须额外生成一张“数据库总体 ER 图”，包含所有实体及其关系。
     4. 如果源码中未发现实体定义，标记章节 status=failed，并在报告中写明“未发现实体”。

3 表（tables）
   - 对 plan.wantTable=true 的节点（含 list.items），逐条执行 tablePlan，生成符合 schema 的 JSON 数组数据：
     - tables[i].dataPath = "./paper/exports/tables/Tab-<chapter>-<index>__<slug>.json"
     - tables[i].status   = "done" | "failed"
   - 不进行渲染（渲染到三线表样式由后续导出工具负责）。

4 列表型章节（mode=list）
   - 仅将 items[] 渲染为编号段落（render.as="numbered"），不是标题层级。
   - item 下的 text / figures / tables 按上述同样规则生成与落盘。

5 写入产物（不覆盖）
   - 读取 ./paper/content.json 为基底，拷贝为内存副本，填充 text/figures/tables/status 等；最终落盘到：
     - 若 ./paper/content.run.json 不存在：写入该文件
     - 若已存在：写入 ./paper/content.run.<YYYYMMDD-HHMMSS>.json
   - **绝不修改原始 ./paper/content.json**

数据字段写回规范（运行产物）
- 每个生成的图表项必须包含：
  {
    "id": "<保持原 id 或自动编号>",
    "label": "图<chapter>-<index> <figureTitle>",
    "type": "uml" | "table",
    "umlCodePath": "./paper/exports/uml/Fig-...__.puml",   // 仅图有
    "imagePath":   "./paper/exports/uml/Fig-...__.png",     // 仅图有
    "dataPath":    "./paper/exports/tables/Tab-...__.json", // 仅表有
    "status": "done" | "failed",
    "errors": []   // 失败时填充
  }

输出
1 生成文件：
   - ./paper/content.run.json   或  ./paper/content.run.<YYYYMMDD-HHMMSS>.json
   - 多个 .puml/.png（或 .svg）置于 ./paper/exports/uml/
   - 多个表格 JSON 置于 ./paper/exports/tables/
2 机器可读 JSON（stdout 单行）：
   {
     "status": "success",
     "project": "<projectName>",
     "outlinePath": "./paper/outline.json",
     "contentPath": "./paper/content.json",
     "runContentPath": "./paper/content.run.json",
     "chaptersDone": <int>,
     "figures": { "generated": <int>, "failed": <int> },
     "tables":  { "generated": <int>, "failed": <int> },
     "failList": [
       {"sectionId":"<id>","type":"figure|table|text","name":"<标题或文件名>","reason":"<摘要>"}
     ]
   }
3 人类可读检查报告：
   - 正文生成统计：成功/失败数量
   - 图/表生成统计：生成数、失败数
   - 数据库设计覆盖情况：实体总数、单体图/三线表生成情况、总体 ER 图状态
   - 失败清单：节/子项 → 失败类型 → 文件名（含 .puml/.png/.json） → 失败原因
   - 文件清单预览：uml 目录与 tables 目录下新文件条目数
   - 下一步建议：可进行“流程 04 导出 Word”

注意
- 必须使用 luban-uml 渲染所有 UML 图片；**图片与 UML 源码同名且同目录**（./paper/exports/uml/）。
- 数据库设计章节必须完整覆盖所有实体，不得遗漏；总体 ER 图必须包含全部实体。
- 若你选择 .svg，请保持同名规则，只是扩展名不同（.puml ↔ .svg）。
- 同名文件会被覆盖（工具默认行为）；如需保留版本请在文件名中加入时间戳或版本号。
- 禁止修改 ./paper/outline.json 与 ./paper/content.json；仅生成新的运行产物与导出资产。
- 若任一关键输入缺失或解析失败，打印错误并停止；不要写入损坏文件。