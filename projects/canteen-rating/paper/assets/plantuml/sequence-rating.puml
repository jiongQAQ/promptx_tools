@startuml
!theme plain
skinparam backgroundColor White
skinparam sequence {
  ArrowColor #0277BD
  LifeLineBorderColor #0277BD
  LifeLineBackgroundColor #E1F5FE
  ParticipantBorderColor #0277BD
  ParticipantBackgroundColor #E1F5FE
  ParticipantFontSize 12
  MessageAlignment center
}
skinparam note {
  BackgroundColor #FFF9C4
  BorderColor #F57F17
}
skinparam linetype ortho

title 菜品评价系统时序图

participant "Vue前端" as Frontend
participant "RatingController" as Controller
participant "RatingService" as Service
participant "SensitiveWordService" as FilterSvc
participant "RatingMapper" as Mapper
participant "DishMapper" as DishMapper
participant "MySQL数据库" as DB
participant "异步消息队列" as Queue

Frontend -> Controller: POST /api/user/rating\n{dishId, score, comment, imagePath}
activate Controller

Controller -> Controller: 参数校验和JWT验证
note right: 检查评分范围1-5分\n验证用户登录状态

Controller -> Service: submitRating(userId, ratingDto)
activate Service

Service -> Mapper: checkExistingRating(userId, dishId)
activate Mapper
Mapper -> DB: SELECT COUNT(*) FROM ratings WHERE user_id=? AND dish_id=?
activate DB
DB --> Mapper: count结果
deactivate DB
Mapper --> Service: 是否已存在评价
deactivate Mapper

alt 用户未评价过该菜品
    Service -> FilterSvc: filterSensitiveContent(comment)
    activate FilterSvc
    FilterSvc --> Service: 过滤后内容
    deactivate FilterSvc

    alt 内容通过安全检查
        Service -> Mapper: insertRating(rating)
        activate Mapper
        Mapper -> DB: BEGIN TRANSACTION
        Mapper -> DB: INSERT INTO ratings VALUES(...)

        Service -> DishMapper: updateDishRating(dishId)
        activate DishMapper
        DishMapper -> DB: UPDATE dishes SET average_rating=?,rating_count=? WHERE id=?
        DishMapper -> DB: COMMIT TRANSACTION
        deactivate DishMapper
        deactivate Mapper

        Service -> Queue: sendRatingNotification(rating)
        activate Queue
        note right: 异步更新缓存\n发送评价通知
        deactivate Queue

        Service --> Controller: RatingResult{success: true, ratingId}
        Controller --> Frontend: {code: 200, message: "评价成功", data: ratingInfo}
    else 内容包含敏感词
        Service --> Controller: 敏感词过滤失败
        Controller --> Frontend: {code: 400, message: "内容包含敏感词，请修改"}
    end
else 用户已评价过
    Service --> Controller: 重复评价错误
    Controller --> Frontend: {code: 409, message: "您已评价过该菜品"}
end

alt 并发冲突处理
    Service -> Mapper: optimisticLockUpdate(rating, version)
    activate Mapper
    Mapper -> DB: UPDATE ratings SET ... WHERE id=? AND version=?

    alt 更新影响行数 > 0
        Mapper --> Service: 更新成功
        Service --> Controller: 操作成功
    else 版本冲突
        Mapper --> Service: 乐观锁冲突
        Service --> Controller: 并发冲突，请重试
        Controller --> Frontend: {code: 409, message: "数据已被修改，请重试"}
    end
    deactivate Mapper
end

deactivate Service
deactivate Controller

@enduml