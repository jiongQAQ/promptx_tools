@startuml
!theme plain
skinparam backgroundColor White
skinparam activity {
  BackgroundColor #E1F5FE
  BorderColor #0277BD
  FontSize 12
}
skinparam arrow {
  Color #0277BD
  FontSize 10
}
skinparam diamond {
  BackgroundColor #FFF3E0
  BorderColor #F57C00
  FontSize 11
}
skinparam linetype ortho

title 菜品评价系统活动图

start

:用户选择菜品进行评价;
:系统检查用户是否已登录;

if (用户已登录?) then (是)
  :系统检查用户是否已评价该菜品;
  if (用户未评价过?) then (是)
    :用户输入评分(1-5分);
    :用户输入评价内容;
    :用户上传评价图片(可选);

    :系统进行内容校验;
    if (内容格式正确?) then (是)
      :系统进行敏感词过滤;
      if (内容安全?) then (是)
        :系统保存评价数据到数据库;
        :异步更新菜品平均评分;
        :异步更新菜品评价数量;
        :发送成功响应给用户;
        :评价提交成功;
      else (否)
        :返回敏感词过滤提示;
        :要求用户修改内容;
      endif
    else (否)
      :返回内容格式错误提示;
    endif
  else (否)
    :返回重复评价错误;
    :提示用户可修改已有评价;
  endif
else (否)
  :跳转到登录页面;
endif

if (并发处理冲突?) then (是)
  :乐观锁检测版本冲突;
  :重试评价提交;
  if (重试成功?) then (是)
    :提交成功;
  else (否)
    :返回系统繁忙提示;
  endif
else (否)
  :正常处理流程;
endif

if (评价修改请求?) then (是)
  if (24小时内?) then (是)
    :允许用户修改评价;
    :更新评价数据;
    :重新计算菜品评分;
  else (否)
    :返回修改时间已过期;
  endif
else (否)
  :完成评价流程;
endif

stop

@enduml