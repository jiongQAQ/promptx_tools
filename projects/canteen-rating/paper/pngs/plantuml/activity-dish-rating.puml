@startuml
!theme plain
skinparam backgroundColor White
skinparam activity {
  BackgroundColor #E1F5FE
  BorderColor #0277BD
  FontSize 12
}
skinparam arrow {
  Color #0277BD
  FontSize 10
}
skinparam diamond {
  BackgroundColor #FFF3E0
  BorderColor #F57C00
  FontSize 11
}
skinparam linetype ortho

start
:菜品浏览请求;
:DishController处理RESTful API;
note right: 支持分页查询、条件筛选、排序

:MyBatis Plus条件构造器;
:动态SQL生成;
note left: 按档口、分类、价格区间\n评分范围等多维度筛选

:菜品信息展示;
note right: 基本属性、统计信息\n用户历史评分状态

:用户选择菜品进行评分;

:用户身份验证;
:JWT Token解析用户ID;

if (身份验证通过?) then (否)
  :返回未授权错误;
  stop
endif

:重复评分检查;
:查询ratings表;
note right: 检查user_id和dish_id的记录\n实现一人一菜一评分规则

if (已存在评分记录?) then (是)
  :返回重复评分异常;
  stop
endif

:评分值验证;
note left: 确保评分在1-5范围内\n且为有效数值

if (评分值有效?) then (否)
  :返回数据验证异常;
  stop
endif

:开启数据库事务;
fork
  :插入评分记录;
  note right: 记录user_id, dish_id, rating_value
fork again
  :更新菜品平均分;
  note right: 使用SQL聚合函数\nAVG(rating_value)计算
end fork

:乐观锁机制处理并发;
note left: 版本号字段防止更新冲突

if (事务执行成功?) then (否)
  :回滚事务;
  :返回数据库操作异常;
  stop
endif

:提交事务;

:评价展示更新;
if (展示模式?) then (列表模式)
  :显示最新评价和热门评价;
elseif (统计模式) then
  :显示评分分布和趋势分析;
elseif (个人模式) then
  :显示用户历史评价记录;
endif

:双重数据验证;
fork
  :前端表单验证;
  note right: Element Plus验证规则
fork again
  :后端业务验证;
  note right: Hibernate Validator注解
end fork

:评分提交成功;
stop

@enduml