@startuml
!theme plain
skinparam backgroundColor White
skinparam sequence {
  ArrowColor #0277BD
  LifeLineBorderColor #0277BD
  LifeLineBackgroundColor #E1F5FE
  ParticipantBorderColor #0277BD
  ParticipantBackgroundColor #E1F5FE
  ParticipantFontSize 12
  MessageAlignment center
}
skinparam note {
  BackgroundColor #FFF9C4
  BorderColor #F57F17
}
skinparam linetype ortho

participant "前端界面" as Frontend
participant "DishController" as Controller
participant "JWT认证" as JWT
participant "DishService" as Service
participant "RatingService" as RatingService
participant "MyBatis Plus" as Mapper
participant "数据库" as DB

== 菜品浏览阶段 ==

Frontend -> Controller: GET /api/dishes?page=1&size=10
activate Controller
Controller -> Service: 分页查询菜品列表
activate Service
Service -> Mapper: 条件构造器动态SQL
activate Mapper
note right: 按档口、分类、价格区间\n评分范围等多维度筛选
Mapper -> DB: 执行查询SQL
activate DB
DB --> Mapper: 菜品数据结果集
deactivate DB
Mapper --> Service: 菜品分页数据
deactivate Mapper
Service --> Controller: 菜品展示信息
note left: 基本属性、统计信息\n用户历史评分状态
deactivate Service
Controller --> Frontend: JSON响应数据
deactivate Controller

== 评分提交阶段 ==

Frontend -> Controller: POST /api/ratings
note right: 包含dish_id和rating_value
activate Controller

Controller -> JWT: 解析Token获取用户ID
activate JWT
JWT --> Controller: 用户身份信息
deactivate JWT

alt 身份验证失败
  Controller --> Frontend: 401 未授权错误
else 身份验证通过
  Controller -> RatingService: 提交评分请求
  activate RatingService

  RatingService -> Mapper: 查询重复评分
  activate Mapper
  Mapper -> DB: SELECT COUNT(*) FROM ratings WHERE user_id=? AND dish_id=?
  activate DB
  DB --> Mapper: 查询结果
  deactivate DB
  Mapper --> RatingService: 重复评分检查结果
  deactivate Mapper

  alt 存在重复评分
    RatingService --> Controller: 重复评分异常
    Controller --> Frontend: 400 重复评分错误
  else 通过重复检查
    RatingService -> RatingService: 评分值验证(1-5范围)

    alt 评分值无效
      RatingService --> Controller: 数据验证异常
      Controller --> Frontend: 400 参数错误
    else 评分值有效
      RatingService -> DB: 开启数据库事务
      activate DB

      RatingService -> Mapper: 插入评分记录
      activate Mapper
      Mapper -> DB: INSERT INTO ratings
      note right: user_id, dish_id, rating_value
      DB --> Mapper: 插入结果
      Mapper --> RatingService: 评分记录创建成功
      deactivate Mapper

      RatingService -> Mapper: 更新菜品平均分
      activate Mapper
      Mapper -> DB: UPDATE dishes SET avg_rating = (SELECT AVG(rating_value)...)
      note right: 使用SQL聚合函数\n实时计算平均值
      DB --> Mapper: 更新结果
      Mapper --> RatingService: 平均分更新成功
      deactivate Mapper

      alt 乐观锁冲突
        DB --> RatingService: 版本冲突异常
        RatingService -> DB: 回滚事务
        RatingService --> Controller: 并发冲突错误
        Controller --> Frontend: 409 冲突错误
      else 事务成功
        RatingService -> DB: 提交事务
        DB --> RatingService: 事务提交成功
        deactivate DB

        RatingService --> Controller: 评分提交成功
        deactivate RatingService
        Controller --> Frontend: 200 成功响应
        deactivate Controller
      end
    end
  end
end

== 评价展示更新 ==

Frontend -> Controller: GET /api/dishes/{dishId}/ratings
activate Controller
Controller -> Service: 获取评价展示数据
activate Service
Service -> Mapper: 查询评价数据
activate Mapper

alt 列表模式
  Mapper -> DB: 查询最新评价和热门评价
else 统计模式
  Mapper -> DB: 查询评分分布和趋势
else 个人模式
  Mapper -> DB: 查询用户历史评价
end

activate DB
DB --> Mapper: 评价展示数据
deactivate DB
Mapper --> Service: 格式化评价信息
deactivate Mapper
Service --> Controller: 评价展示结果
deactivate Service
Controller --> Frontend: 评价数据响应
deactivate Controller

@enduml