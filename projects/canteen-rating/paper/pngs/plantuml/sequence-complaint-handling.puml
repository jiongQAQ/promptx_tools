@startuml
!theme plain
skinparam backgroundColor White
skinparam sequence {
  ArrowColor #0277BD
  LifeLineBorderColor #0277BD
  LifeLineBackgroundColor #E1F5FE
  ParticipantBorderColor #0277BD
  ParticipantBackgroundColor #E1F5FE
  ParticipantFontSize 12
  MessageAlignment center
}
skinparam note {
  BackgroundColor #FFF9C4
  BorderColor #F57F17
}
skinparam linetype ortho

participant "用户界面" as UI
participant "投诉控制器" as Controller
participant "敏感词过滤器" as Filter
participant "分类识别器" as Classifier
participant "工作流引擎" as Workflow
participant "通知服务" as Notification
participant "定时任务" as Scheduler
participant "数据库" as DB

UI -> Controller: 提交投诉内容
activate Controller
Controller -> Controller: 用户身份验证
note right: 确保投诉的真实性和可追溯性

Controller -> Filter: 敏感词过滤检测
activate Filter
Filter -> Filter: Trie树算法处理
Filter --> Controller: 过滤结果
deactivate Filter

Controller -> Controller: 内容长度和格式验证
Controller -> Controller: 重复投诉检测
note right: 文本相似度算法

alt 验证失败
  Controller --> UI: 返回验证错误
else 验证通过
  Controller -> Classifier: 智能分类识别
  activate Classifier
  Classifier -> Classifier: 关键词匹配
  note right: 食品质量、服务态度\n环境卫生、价格问题
  Classifier --> Controller: 投诉分类结果
  deactivate Classifier

  Controller -> Workflow: 创建投诉工作流
  activate Workflow
  Workflow -> Workflow: 分级处理判断
  note right: 普通/重要/紧急投诉

  alt 紧急投诉
    Workflow -> Notification: 触发即时通知
    activate Notification
    Notification -> Notification: 发送多渠道通知
    note right: 邮件、短信、系统消息
    Notification --> Workflow: 通知发送完成
    deactivate Notification
  end

  Workflow -> DB: 保存投诉记录
  activate DB
  DB --> Workflow: 保存成功
  deactivate DB

  Workflow -> Scheduler: 设置响应时限监控
  activate Scheduler
  note right: 一般投诉24小时\n紧急投诉2小时

  Workflow --> Controller: 工作流创建完成
  deactivate Workflow

  Controller --> UI: 投诉提交成功
  deactivate Controller
end

== 处理过程监控 ==

Scheduler -> Scheduler: 定时检查处理进度
alt 超时检测
  Scheduler -> Notification: 触发预警机制
  activate Notification
  Notification -> Notification: 发送超时警告
  Notification --> Scheduler: 预警发送完成
  deactivate Notification
end

== 处理完成反馈 ==

Workflow -> DB: 更新处理状态
activate DB
DB --> Workflow: 状态更新完成
deactivate DB

Workflow -> Notification: 结果反馈通知
activate Notification
Notification -> UI: 系统内消息
Notification -> Notification: 邮件通知
Notification -> Notification: 短信提醒
Notification --> Workflow: 反馈通知完成
deactivate Notification

Workflow -> Workflow: 记录处理轨迹
note right: 处理人员、处理时间\n处理措施、用户反馈

Workflow -> Workflow: 生成统计分析数据
note right: 投诉趋势分析\n问题热点识别

deactivate Scheduler

@enduml