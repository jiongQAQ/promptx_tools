@startuml
!theme plain
skinparam backgroundColor White
skinparam activity {
  BackgroundColor #E1F5FE
  BorderColor #0277BD
  FontSize 12
}
skinparam arrow {
  Color #0277BD
  FontSize 10
}
skinparam diamond {
  BackgroundColor #FFF3E0
  BorderColor #F57C00
  FontSize 11
}
skinparam linetype ortho

start
:管理员访问档口管理界面;
:RBAC权限验证;
note right: Spring Security @PreAuthorize注解\n方法级权限控制

if (用户角色权限验证?) then (普通用户)
  :返回权限不足错误;
  stop
elseif (管理员或系统管理员) then
  :允许访问管理功能;
endif

:选择管理操作类型;

if (操作类型?) then (档口新增)
  :档口信息输入;
  :数据完整性校验;
  note right: 档口名称唯一性检查\n联系方式格式验证\n营业时间合理性验证

  if (数据校验通过?) then (否)
    :返回数据验证错误;
    stop
  endif

  :创建档口记录;

elseif (档口修改) then
  :选择待修改档口;
  :乐观锁版本控制;
  note right: version字段防止\n并发修改冲突

  :修改档口信息;

  if (版本冲突?) then (是)
    :返回并发修改错误;
    stop
  endif

  :更新档口记录;

elseif (档口删除) then
  :选择待删除档口;
  :软删除策略;
  note right: 设置deleted字段\n保留历史数据用于审计

  :级联处理关联菜品;
  :保留历史评分数据;

elseif (菜品管理) then
  :验证档口归属关系;
  note right: 确保管理员只能管理\n自己负责的档口菜品

  if (归属权限验证?) then (否)
    :返回权限不足错误;
    stop
  endif

  if (菜品操作类型?) then (单个操作)
    :菜品增删改操作;
  elseif (批量操作) then
    :事务机制;
    note right: 批量上架、下架\n价格调整等操作的原子性
    :批量菜品操作;
  endif

elseif (状态控制) then
  :档口状态管理;
  note left: 营业中、暂停营业\n维护中、已关闭

  :状态转换业务规则验证;

  if (状态变更为暂停营业?) then (是)
    :级联下架所有关联菜品;
    note right: 避免用户对不可用\n菜品进行评分
  endif

  :更新档口状态;
endif

:操作日志记录;
note left: 记录操作人员、操作时间\n操作内容等详细信息

:多层数据验证;
fork
  :前端表单验证;
  note right: 即时反馈
fork again
  :后端参数验证;
  note right: 数据安全
fork again
  :业务逻辑验证;
  note right: 业务规则一致性
end fork

:档口管理操作完成;
stop

@enduml