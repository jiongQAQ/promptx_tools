@startuml
!theme plain
skinparam backgroundColor White
skinparam sequence {
  ArrowColor #0277BD
  LifeLineBorderColor #0277BD
  LifeLineBackgroundColor #E1F5FE
  ParticipantBorderColor #0277BD
  ParticipantBackgroundColor #E1F5FE
  ParticipantFontSize 12
  MessageAlignment center
}
skinparam note {
  BackgroundColor #FFF9C4
  BorderColor #F57F17
}
skinparam linetype ortho

participant "统计界面" as UI
participant "StatisticsController" as Controller
participant "Redis缓存" as Redis
participant "Spring Cache" as Cache
participant "统计引擎" as Engine
participant "消息队列" as MQ
participant "计算任务" as Task
participant "报表生成器" as Report
participant "Quartz调度器" as Quartz
participant "通知服务" as Notification
participant "数据库" as DB

== 统计请求处理 ==

UI -> Controller: GET /api/statistics?dimension=daily
activate Controller
Controller -> Controller: 确定统计维度和参数
note right: 时间、空间、业务维度

Controller -> Redis: 检查缓存
activate Redis
Redis --> Controller: 缓存查询结果
deactivate Redis

alt Redis缓存命中
  Controller --> UI: 返回缓存统计结果
else Redis缓存未命中
  Controller -> Cache: 检查应用层缓存
  activate Cache
  Cache --> Controller: Spring Cache查询结果
  deactivate Cache

  alt 应用层缓存命中
    Controller --> UI: 返回缓存结果
  else 缓存未命中
    Controller -> DB: 检查物化视图
    activate DB
    DB --> Controller: 预计算结果查询
    deactivate DB

    alt 物化视图可用
      Controller --> UI: 返回预计算结果
    else 需要实时计算
      Controller -> Engine: 启动统计计算
      activate Engine

      Engine -> Engine: 评估数据量大小

      alt 小数据量
        Engine -> DB: 实时SQL聚合计算
        activate DB
        note right: COUNT、SUM、AVG、MAX、MIN
        DB --> Engine: 聚合计算结果
        deactivate DB
      else 大数据量
        Engine -> MQ: 分发计算任务
        activate MQ
        note right: MapReduce并行处理\n拆分为多个子任务

        MQ -> Task: 异步计算任务
        activate Task
        Task -> Task: 并行数据处理
        Task -> UI: WebSocket推送进度
        note right: 实时推送处理进度\n避免阻塞用户界面
        Task --> MQ: 返回计算结果
        deactivate Task
        MQ --> Engine: 合并计算结果
        deactivate MQ
      end

      Engine -> Engine: 趋势分析算法处理
      note right: 时间序列分析\n移动平均、指数平滑

      Engine -> Engine: 数据一致性检查
      note right: 异常值检测\n业务逻辑验证

      Engine --> Controller: 统计结果生成完成
      deactivate Engine

      Controller -> Report: 生成报表
      activate Report

      alt 在线报表
        Report -> Report: ECharts动态图表生成
        note right: 柱状图、折线图\n饼图、热力图
      else 离线报表
        alt Excel格式
          Report -> Report: POI库Excel生成
        else PDF格式
          Report -> Report: iText库PDF生成
        end
      end

      Report -> Report: 应用可配置报表模板
      note right: 自定义报表字段\n统计周期、图表类型

      Report --> Controller: 报表生成完成
      deactivate Report

      Controller -> Redis: 更新Redis缓存
      activate Redis
      note right: 动态调整有效期
      Redis --> Controller: 缓存更新完成
      deactivate Redis

      Controller -> Cache: 更新Spring Cache
      activate Cache
      Cache --> Controller: 应用缓存更新完成
      deactivate Cache

      Controller -> DB: 刷新物化视图
      activate DB
      note right: 定时刷新保证准确性
      DB --> Controller: 物化视图更新完成
      deactivate DB

      Controller --> UI: 返回统计分析结果
      deactivate Controller
    end
  end
end

== 定时任务调度 ==

Quartz -> Quartz: 定时触发统计任务
activate Quartz
note right: 生成日报、周报、月报

Quartz -> Engine: 执行定期统计计算
activate Engine
Engine -> DB: 批量统计计算
activate DB
DB --> Engine: 统计数据
deactivate DB

Engine -> Report: 生成定期报表
activate Report
Report --> Engine: 报表生成完成
deactivate Report

Engine --> Quartz: 统计任务完成
deactivate Engine

Quartz -> Notification: 发送通知
activate Notification
Notification -> Notification: 邮件自动发送
Notification -> Notification: 系统消息通知
Notification --> Quartz: 通知发送完成
deactivate Notification

deactivate Quartz

== 缓存失效策略 ==

note over Redis, DB: 主动失效：数据更新时清除相关缓存\n被动失效：超时数据重新计算

@enduml