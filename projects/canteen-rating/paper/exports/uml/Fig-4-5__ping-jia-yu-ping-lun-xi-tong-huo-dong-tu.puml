@startuml
skinparam activity {
  BackgroundColor #FFFFFF
  BorderColor #333333
  FontColor #333333
}

skinparam swimlane {
  BorderColor #333333
  TitleFontColor #333333
}

title 评价与评论系统活动图

|用户|
start
:选择要评价的菜品;
:填写评分(1-5星);
:填写评论内容(可选);
:提交评价;

|系统|
:接收评价请求;
:验证用户身份;

if (用户已登录?) then (否)
  :返回未登录错误;
  |用户|
  :跳转到登录页面;
  stop
else (是)
  :验证菜品存在性;

  |数据库|
  :查询菜品信息;

  if (菜品存在?) then (否)
    |系统|
    :返回菜品不存在错误;
    |用户|
    :显示菜品不存在提示;
    stop
  else (是)
    |系统|
    :检查重复评价;

    |数据库|
    :查询用户对该菜品的评价;

    if (已评价过?) then (是)
      |系统|
      :返回重复评价错误;
      |用户|
      :显示已评价过提示;
      stop
    else (否)
      |系统|
      :验证评价数据格式;

      if (数据格式正确?) then (否)
        :返回数据格式错误;
        |用户|
        :显示格式错误提示;
        stop
      else (是)
        if (包含评论内容?) then (是)
          |敏感词过滤系统|
          :检测敏感词;

          if (包含敏感词?) then (是)
            |系统|
            :返回内容违规错误;
            |用户|
            :显示内容违规提示;
            stop
          else (否)
            :内容通过审核;
          endif
        endif

        |系统|
        :构建评价实体;
        :设置评价状态为待审核;

        |数据库|
        :插入评价记录;

        if (插入成功?) then (否)
          |系统|
          :返回数据库错误;
          |用户|
          :显示保存失败提示;
          stop
        else (是)
          |系统|
          :计算菜品平均评分;
          :更新菜品评价统计;

          |数据库|
          :更新菜品统计数据;

          |系统|
          :清除相关缓存;
          :返回评价成功响应;

          |用户|
          :显示评价成功消息;
          :刷新菜品详情页面;
          stop
        endif
      endif
    endif
  endif
endif

@enduml