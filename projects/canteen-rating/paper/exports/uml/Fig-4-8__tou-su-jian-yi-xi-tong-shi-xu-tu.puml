@startuml
!define USER_COLOR #E1F5FE
!define CONTROLLER_COLOR #F1F8E9
!define SERVICE_COLOR #E8F5E9
!define NOTIFY_COLOR #FFF3E0
!define DB_COLOR #FFEBEE

skinparam participant {
  BackgroundColor #FFFFFF
  BorderColor #333333
  FontColor #333333
}

title 投诉建议系统时序图

participant "用户" as User USER_COLOR
participant "ComplaintController" as Controller CONTROLLER_COLOR
participant "ComplaintService" as Service SERVICE_COLOR
participant "SensitiveWordService" as FilterService SERVICE_COLOR
participant "NotificationService" as NotifyService NOTIFY_COLOR
participant "ComplaintMapper" as Mapper SERVICE_COLOR
participant "MySQL数据库" as DB DB_COLOR

User -> Controller: POST /api/user/complaints(type, title, description, canteenId)
activate Controller

Controller -> Controller: 验证用户登录状态
alt 用户未登录
  Controller --> User: 401 Unauthorized
  deactivate Controller
else 用户已登录
  Controller -> Controller: 验证请求参数

  alt 参数验证失败
    Controller --> User: 400 Bad Request
    deactivate Controller
  else 参数验证成功
    Controller -> Service: createComplaint(userId, complaintData)
    activate Service

    Service -> Service: 验证内容长度限制
    alt 内容长度超限
      Service --> Controller: ContentTooLongException
      Controller --> User: 400 Content Too Long
      deactivate Service
      deactivate Controller
    else 内容长度合规
      Service -> FilterService: checkSensitiveWords(title + description)
      activate FilterService
      FilterService -> DB: SELECT word FROM sensitive_words
      activate DB
      DB --> FilterService: 敏感词列表
      deactivate DB
      FilterService -> FilterService: 执行敏感词检测
      alt 包含敏感词
        FilterService --> Service: 敏感词列表
        deactivate FilterService
        Service --> Controller: SensitiveWordException
        Controller --> User: 400 Content Violation
        deactivate Service
        deactivate Controller
      else 内容安全
        FilterService --> Service: 内容审核通过
        deactivate FilterService

        alt 指定了食堂ID
          Service -> Service: validateCanteenExists(canteenId)
          Service -> DB: SELECT * FROM canteens WHERE id = ?
          activate DB
          alt 食堂不存在
            DB --> Service: 空结果集
            deactivate DB
            Service --> Controller: CanteenNotFoundException
            Controller --> User: 404 Canteen Not Found
            deactivate Service
            deactivate Controller
          else 食堂存在
            DB --> Service: 食堂数据
            deactivate DB
          end
        end

        Service -> Service: 生成投诉编号(CP + 年月日 + 序号)
        Service -> Service: 构建Complaint实体对象
        Service -> Mapper: insert(complaint)
        activate Mapper
        Mapper -> DB: INSERT INTO complaints (complaint_no, user_id, type, title, ...)
        activate DB
        DB --> Mapper: 插入成功，返回ID
        deactivate DB
        Mapper --> Service: 投诉ID
        deactivate Mapper

        Service -> NotifyService: notifyAdminsNewComplaint(complaint)
        activate NotifyService
        NotifyService -> NotifyService: 发送邮件/短信通知
        NotifyService -> DB: INSERT INTO notifications (admin_id, type, content, ...)
        activate DB
        DB --> NotifyService: 通知记录保存成功
        deactivate DB
        NotifyService --> Service: 通知发送完成
        deactivate NotifyService

        Service --> Controller: 创建成功的投诉对象
        deactivate Service

        Controller --> User: 201 Created + 投诉编号
        deactivate Controller
      end
    end
  end
end

User -> User: 显示提交成功消息
User -> User: 记录投诉编号

note over Service
  投诉编号生成规则：
  CP + YYYYMMDD + 4位序号
  例：CP20251225001
end note

note over FilterService
  内容审核规则：
  - 标题：1-100字符
  - 描述：10-1000字符
  - 敏感词过滤
end note

note over NotifyService
  通知方式：
  - 系统内通知
  - 邮件通知管理员
  - 短信通知(紧急投诉)
end note

@enduml