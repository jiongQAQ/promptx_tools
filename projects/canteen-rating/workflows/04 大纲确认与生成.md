【流程 01｜大纲确认→生成→功能章节扩展＋技术占位符实填｜通用】

=== 路径定义 ===
<projectRoot> = $(pwd)  # 当前工作目录的绝对路径
使用说明：执行前请确保在项目根目录下运行，所有相对路径将基于此目录解析

你的当前工作目录为 <projectRoot>/（例如 projects/gym）。请仅操作大纲文件，不生成正文或图表。

—— 阶段一：大纲确认与生成 ——
目标：
1. 读取模板：<projectRoot>/templates/outline.template.json
2. 与我确认使用方式（A/B/C/D 四选一），生成大纲文件：
   - 输出到 <projectRoot>/paper/outline.json （若 <projectRoot>/paper/ 不存在请创建）
   - 选择模式：
     A) 直接使用模板原样生成
     B) 使用模板 + 你根据 <projectRoot>/source/ 的代码提出"建议新增章节"，待我确认后再写入
     C) 我将粘贴"自定义大纲"（文本或 JSON），你据此规范化为最终大纲
     D) 基于参考论文生成大纲（新增）
        - 自动扫描 <projectRoot>/reference-papers/*.md
        - 若存在多个参考论文，列出供我选择
        - 调用 Workflow 02.5 解析参考论文结构 → 生成 <projectRoot>/paper/reference-structure.json
        - 基于参考论文的章节结构生成 outline.json
3. 生成完成后输出：
   - 机器可读摘要（stdout 单行 JSON）
   - 人类可读检查报告（校验结果、差异、新增、占位符待确认等）

—— 阶段二：功能章节扩展（编号不固定，按标题匹配） ——
目标：
1. 在 <projectRoot>/paper/outline.json 中，查找标题包含以下关键词的章节：
   - "系统功能详细设计"
   - "系统功能实现"
   - "系统功能测试"
2. 若存在"系统功能详细设计"：
   - 基于 <projectRoot>/source/ 与（如存在）<projectRoot>/CLAUDE.md，自行分析识别系统核心功能模块（≤5）。
   - 在“系统功能详细设计”下生成子节点：《<功能名>的详细设计》
   - 在“系统功能实现”下生成子节点：《<功能名>的实现》
   - 在“系统功能测试”下生成子节点：《<功能名>功能测试》
   - 三类子节点必须一一对应、顺序一致；子节点 id 以父 id 为前缀，.1 起连续编号。
3. 若仅存在其中一类章节（例如只有“系统功能实现”），同样基于源码推断功能模块并生成对应子节点。
4. 若三类均不存在，则跳过扩展并说明原因。

—— 阶段三：技术占位符实填（“相关技术介绍”中的 {{jishu1}}/{{jishu2}}/{{jishu3}}） ——
目标：
1. 在 <projectRoot>/paper/outline.json 中定位"相关技术介绍"章节下的 1.4.1 / 1.4.2 / 1.4.3（或任何等价的小节标题中包含 {{jishu1}} / {{jishu2}} / {{jishu3}} 的节点，编号位置可能不同）。
2. 基于项目的**真实证据**自行分析（读取 <projectRoot>/source/ 与 <projectRoot>/CLAUDE.md，如存在），识别该项目最具代表性的三项技术（例如后端框架/数据访问层/缓存/认证/数据库/前端等不同维度各取其一），并按"相关性与重要性"排序为 jishu1、jishu2、jishu3：
   - 对每个 {{jishuX}} 生成 3–4 个候选（来源于你的证据分析），并在**不等待确认**的前提下自动选定 1 项用于替换。
   - 仅替换标题占位符文本，不改变节点结构/id/顺序。
3. 若未找到占位符节点，输出说明并跳过本阶段；不得新建“相关技术介绍”节点。

—— 阶段四：输出 ——
1. 覆盖写回 <projectRoot>/paper/outline.json（UTF-8）
2. 机器可读摘要（stdout 单行 JSON），示例字段：
   {
     "status": "success",
     "project": "<projectName>",
     "outlinePath": "<projectRoot>/paper/outline.json",
     "nodeCount": <整数>,
     "rootIds": ["1","2","3",...],
     "mode": "template | template+suggest | custom | reference",
     "addedNodes": ["3.3 …", ...],
     "functions": ["…","…"],                         // 若做了功能扩展
     "expandedChapters": {                           // 若做了功能扩展
       "系统功能详细设计": ["…", "..."],
       "系统功能实现": ["…", "..."],
       "系统功能测试": ["…", "..."]
     },
     "techPlaceholders": {                           // 技术占位符替换结果（若存在）
       "jishu1": { "picked":"…", "candidates":["…","…","…"], "evidence":["…","…"] , "nodeId":"<如 1.4.1>" },
       "jishu2": { "picked":"…", "candidates":["…","…","…"], "evidence":["…"]      , "nodeId":"<如 1.4.2>" },
       "jishu3": { "picked":"…", "candidates":["…","…","…"], "evidence":["…"]      , "nodeId":"<如 1.4.3>" }
     }
   }
3. 人类可读检查报告（普通文本）：
   - 模式选择与结构校验结果（A/B/C/D）
   - 新增或修改的章节（含 id 映射）
   - 参考论文解析结果（仅模式D）：
     • 参考论文来源文件
     • 提取的章节总数
     • 识别的特殊模式（父章节内容规则、命名模式等）
     • 生成的 reference-structure.json 路径
   - 功能模块扩展（如适用）：
     • 识别出的功能模块（≤5）及证据来源
     • 扩展子节点清单（按三类章节分组）
     • 对应关系与编号校验结果
   - 技术占位符替换（如适用）：
     • 每个 {{jishuX}} 的候选清单（编号 1/2/3/4）
     • 采纳项与采纳理由
     • 证据清单（来源文件/模块/配置/说明）
     • 被替换节点的 id 与新标题
   - 覆盖写入确认：<projectRoot>/paper/outline.json

—— 约束与容错 ——
- 全流程仅操作 <projectRoot>/paper/outline.json；不得读写/创建其他文件（content.json、images、docx 等）。
- 功能与技术的判定必须来源于项目真实证据；若证据不足，仍需给出候选并在报告中标注“依据不足”。
- 不得增删无关节点与层级，不得变更已有节点 id 或顺序；仅允许：
  • 在“系统功能详细设计/实现/测试”三类章节下新增其**直接子节点**（如执行了功能扩展）；
  • 在存在 {{jishuX}} 的节点中替换标题占位符文本（技术占位符实填）。
- 模板缺失/非法或写入失败时，明确报错并停止，不写损坏文件。