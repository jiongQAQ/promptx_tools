# 📄 论文导出与格式化

## 🚧 状态：待实现

本工作流尚未实现，此文档为功能预留位置。

## 🎯 目标

将 AI 生成的论文内容导出为符合学校格式要求的 Word 文档（.docx），实现从 JSON 数据到标准化毕业论文的自动转换。

**通用性设计**: 基于配置驱动，支持不同学校的论文格式要求。

## 📋 适用场景

当论文内容生成完成后：
- 将 JSON 格式的章节内容转换为 Word 文档
- 应用学校的格式规范（字体、字号、行距、边距等）
- 生成封面、声明、目录、摘要、正文、参考文献
- 支持重复导出和格式调整

## 路径约定

```
<projectRoot>/
├── paper/
│   ├── chapters/
│   │   └── chapters.json            # 输入：章节内容
│   ├── thesis-info.json             # 输入：论文元信息
│   └── 毕业论文.docx                # 输出：最终文档
├── thesis-formats/
│   └── 玉溪师范学院.json            # 输入：格式配置
└── tools/
    ├── export-thesis-to-word.py     # 工具：导出脚本
    └── format_loader.py             # 工具：配置加载器
```

## 🔄 预期执行流程

### Phase 1: 数据准备检查

```bash
# 检查必需文件
✓ paper/chapters/chapters.json      # 章节内容
✓ paper/thesis-info.json            # 论文信息
✓ thesis-formats/玉溪师范学院.json  # 格式配置
```

### Phase 2: 配置加载

```python
# 加载格式配置
config = FormatLoader.load('thesis-formats/玉溪师范学院.json')

# 验证配置完整性
config.validate()
```

### Phase 3: 文档生成

**生成顺序**:
1. **创建文档** - 初始化 Word 文档对象
2. **页面设置** - 应用纸张、边距、页眉页脚配置
3. **样式定义** - 创建正文、标题、摘要等样式
4. **封面生成** - 学科分类号、校徽、学校名称、论文信息
5. **声明页** - 原创性声明、使用授权声明
6. **目录页** - 自动目录（需手动更新）
7. **中文摘要** - 标题、正文、关键词
8. **英文摘要** - 标题、正文、关键词
9. **正文章节** - 递归生成多层级章节
10. **参考文献** - 按 GB/T 7714-2015 格式
11. **保存文档** - 输出到 paper/毕业论文.docx

### Phase 4: 导出完成

**输出文件**: `paper/毕业论文.docx`

**后续手动操作**:
- [ ] 在 Word 中打开文档
- [ ] 更新目录（右键目录 → 更新域）
- [ ] 添加校徽图片（封面左上角）
- [ ] 设置页眉（章标题）
- [ ] 设置页码（摘要罗马数字，正文阿拉伯数字）
- [ ] 插入图表（根据占位符）
- [ ] 检查格式（使用格式检查清单）

## 📊 输入数据格式

### thesis-info.json 示例

```json
{
  "category": "TP311.52",
  "title": "基于Spring Boot的食堂评分系统的设计与实现",
  "author": "张三",
  "student_id": "2021001234",
  "college": "数学与信息技术学院",
  "major": "计算机科学与技术",
  "supervisor": "李明",
  "title_level": "副教授",
  "date": "2025年5月",
  "abstract_cn": "中文摘要内容...",
  "keywords_cn": "关键词1；关键词2；关键词3",
  "abstract_en": "English abstract...",
  "keywords_en": "keyword1; keyword2; keyword3",
  "references": [
    {
      "id": "[1]",
      "content": "作者. 书名[M]. 出版社, 年份."
    }
  ]
}
```

### chapters.json 示例

```json
{
  "chapters": [
    {
      "title": "绪论",
      "level": 1,
      "content": "本章介绍...",
      "subsections": [
        {
          "title": "研究背景",
          "level": 2,
          "content": "随着...",
          "subsections": []
        }
      ]
    }
  ]
}
```

## 🎨 格式应用机制

### 配置驱动架构

```python
class ThesisFormatter:
    def __init__(self, doc, config):
        self.doc = doc
        self.config = config  # 从 JSON 加载的配置

    def _setup_page(self):
        """从配置应用页面设置"""
        section = self.doc.sections[0]
        section.page_width = Cm(self.config.page_setup.width_cm)
        section.page_height = Cm(self.config.page_setup.height_cm)
        # ...

    def _setup_styles(self):
        """从配置创建样式"""
        normal = self.doc.styles['Normal']
        normal.font.name = self.config.fonts.english
        normal.font.size = Pt(self.config.font_sizes[
            self.config.styles.normal.size
        ])
        # ...
```

### 样式映射

| 元素 | 配置路径 | Word 样式 |
|------|---------|-----------|
| 正文 | `styles.normal` | Normal |
| 一级标题 | `styles.heading_1` | Heading 1 |
| 二级标题 | `styles.heading_2` | Heading 2 |
| 摘要标题 | `styles.abstract_title` | 自定义样式 |

## 🔧 已实现功能（参考）

当前项目中已有原型实现：
- ✅ `tools/export-thesis-to-word.py` - 基础导出功能（硬编码格式）
- ✅ 封面、声明、目录、摘要、正文、参考文献生成
- ✅ 递归章节处理
- ✅ 字体和行距设置

## 🚀 待实现功能

### P1 核心功能
- ⏳ 配置文件加载器（`format_loader.py`）
- ⏳ 配置驱动的样式应用
- ⏳ 重构 `export-thesis-to-word.py` 为配置驱动模式
- ⏳ 支持多学校格式切换

### P2 增强功能
- ⏳ 图表占位符自动插入
- ⏳ 参考文献自动编号和引用
- ⏳ 页眉页脚自动设置
- ⏳ 可更新的目录生成

### P3 扩展功能
- ⏳ PDF 导出支持
- ⏳ 格式验证工具
- ⏳ 批量导出（多个版本）
- ⏳ 差异对比功能

## ⚠️ 技术限制

### python-docx 限制
以下功能 python-docx 无法实现，需手动处理：

1. **自动更新的目录** - 只能生成静态目录，需在 Word 中手动更新
2. **页眉页脚页码** - 无法设置不同的页码格式（罗马/阿拉伯）
3. **校徽图片** - 需手动插入并定位
4. **域代码** - 无法生成 Word 的域代码（如交叉引用）

### 解决方案
- 生成占位符文本，提示用户手动处理
- 提供详细的手动操作清单
- 考虑使用 python-docx-template 或 Word COM API

## 📖 使用示例

### 基础导出
```bash
# 激活虚拟环境
source .venv/bin/activate

# 导出论文
python3 tools/export-thesis-to-word.py

# 输出: paper/毕业论文.docx
```

### 指定格式配置
```bash
python3 tools/export-thesis-to-word.py \
  --config thesis-formats/云南大学.json \
  --output paper/毕业论文_云大格式.docx
```

### 预览生成
```bash
# 生成截图预览
python3 tools/word-to-screenshots.py \
  paper/毕业论文.docx \
  paper/preview \
  150
```

## 🔗 工作流依赖

### 前置工作流
- **Workflow 07**: 智能内容生成 → 生成 chapters.json
- **Workflow 10**: 论文格式规范解析 → 生成格式配置

### 后续操作
- 手动调整和完善（添加图表、更新目录等）
- 格式检查（对照学校要求清单）
- 最终提交

## 🎯 质量检查清单

导出完成后，建议按以下清单检查：

### 页面设置
- [ ] 纸张大小: A4
- [ ] 页边距: 上2.5cm, 下2cm, 左2.5cm, 右2cm
- [ ] 页眉页脚距离正确

### 字体字号
- [ ] 正文: 中文宋体, 英文Times New Roman, 小四
- [ ] 一级标题: 宋体, 三号, 加粗
- [ ] 二级标题: 宋体, 小三号, 加粗

### 段落格式
- [ ] 行距: 1.25倍
- [ ] 对齐: 两端对齐
- [ ] 首行缩进: 无（玉溪师范学院要求）

### 内容完整性
- [ ] 封面信息完整
- [ ] 声明页内容正确
- [ ] 中英文摘要和关键词
- [ ] 正文章节完整
- [ ] 参考文献格式正确

## 💡 临时解决方案

在本工作流完全实现前，可以：
1. 使用现有的 `export-thesis-to-word.py`（硬编码版本）
2. 导出后手动调整格式
3. 参考 `玉溪师范学院本科生毕业论文格式要求.md` 进行检查

---

**最后更新**: 2025-09-30
**依赖工作流**: 07, 10
**依赖工具**: export-thesis-to-word.py, format_loader.py (待实现)
**相关文档**: thesis-info.json, chapters.json