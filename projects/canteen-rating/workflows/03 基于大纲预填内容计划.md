# 03 基于大纲预填内容计划

【任务类型】内容计划填充（非成文）｜对齐大纲与模板并自动补齐

你的目标：
基于「大纲文件」与「content 模板文件」以及源码证据，生成一份“扁平化论文 JSON 填充计划”。该计划用于后续正式生成，不得直接产出正文或真实图片/表格文件。若发现“大纲（outline）”与“content 模板（content.template）”不一致，必须以“大纲”为准进行对齐；对模板中存在但大纲缺失的模块，按大纲结构与通用规则补齐同等语义的内容项。

输入
1) 大纲：./paper/outline.json   （权威结构来源，含章节 id/title；可能含 items）
2) 模板：./templates/content.template.json （内容模板与模块提示）
3) 源码：./source/  （后端/前端/数据库/工程脚本等）
4) 文档：./CLAUDE.md（如有，辅助证据）
5) 参考论文：（可选）若用户提供参考论文图片/结构文件，优先学习其模式

输出
- 单一 JSON 数组（扁平化），每个对象至少包含：
  - id, title（完全沿用大纲）
  - word_limit（数字，该章节建议字数，用于控制内容生成长度）
  - 可选字段：text, imagePath, imagePathSequence, tablePath, items（数组，元素含 title/text/imagePath/imagePathSequence/tablePath/word_limit）
- 禁止新增或删除章节，禁止改动 id/title；内容项与多媒体占位需按规则补齐

## 路径变量系统
使用变量替换机制统一管理所有资源路径：
- `${assets}` = paper/assets/
- `${tables}` = paper/assets/tables/
- `${er}` = paper/assets/diagrams/er/
- `${uml}` = paper/assets/diagrams/uml/
- `${impl}` = paper/assets/diagrams/impl/
- `${dfd}` = paper/assets/diagrams/dfd/  （数据流图专用）
- `${flow}` = paper/assets/diagrams/flow/ （传统流程图专用）
- `${plantuml}` = paper/assets/plantuml/

生成路径时使用变量形式，例如：
- ER图：`${er}/Tab-users.svg`
- 表格：`${tables}/Tab-users.json`
- UML图：`${uml}/activity-auth.png`

统一路径规范
- 图片：使用变量路径如 `${uml}/<slug>.png`
- 三线表：使用变量路径如 `${tables}/<slug>.json`
- slug：小写、空格→-、去非法字符、简短可读

对齐与补齐规则（重点）
1) 以大纲为准：当大纲与 content 模板的章节/模块不一致时，保留大纲的结构与顺序；将模板中的计划"映射"到最接近的大纲位置。
2) 语义映射：若名称不一致，基于源码证据（控制器/路由/服务/页面/实体/DDL）进行语义对齐；无法唯一确定时选择最接近的父级或并列位置，在 text 中标注"依据不足，待补充"。
3) 模板缺失项补齐：若大纲存在而模板未覆盖的部分，按模块通用规则自动判断是否需要图/表并补齐相应字段（见下）。
4) 保持"三处对齐"的功能模块集合 M（≤5）：在 4.1（功能详细设计）/ 5.2（功能实现）/ 6.3（功能测试）三处的功能模块必须一一对应、顺序一致；当大纲或模板与源码识别不一致时，最终以"源码证据优先 + 大纲章节容器位置"为准进行归并与命名。

## 图表智能识别引擎

### 识别原则
1. **章节名称语义分析**：基于章节 title 的关键词判断图表需求
2. **层级深度判断**：根据章节深度（id 层级）推断内容类型
3. **源码证据映射**：结合源码结构自动推断合适的图表类型
4. **参考论文学习**：若提供参考论文图片/结构，优先学习其模式

### 图表类型映射规则

#### 架构/设计类章节关键词 → 图类型
- "架构"/"architecture" → 软件架构图 (`${uml}/software-architecture.png`)
- "结构"/"structure" → WBS 结构图 (`${uml}/wbs-*.png`)
- "类图"/"class" → UML 类图 (`${uml}/class-diagram.png`)
- "数据流"/"dataflow"/"DFD" → 数据流图 (`${dfd}/dfd-*.png`)
- "访问流程"/"access flow" → 访问控制流程图 (`${dfd}/access-flow.png`)
- "活动"/"activity" → UML 活动图 (`${uml}/activity-*.png`)
- "时序"/"sequence" → UML 时序图 (`${uml}/sequence-*.png`)
- "用例"/"usecase" → 用例图 (`${uml}/usecase-*.png`)
- "ER"/"实体关系" → ER 图 (`${er}/*` 或 `${uml}/er-overall.png`)

#### 实现类章节关键词 → 图类型
- "功能描述"/"描述" (在第 5 章下) → 流程图 (`${flow}/flow-*.png`)
- "实现过程"/"实现" (在第 5 章下) → 实现截图 (`${impl}/impl-*.png`)
- "界面"/"页面"/"UI" → 界面截图 (`${impl}/ui-*.png`)

#### 测试类章节关键词 → 表类型
- "测试用例"/"test case" → 测试用例表 (`${tables}/test-*.json`)
- "性能"/"performance" → 性能指标表 (`${tables}/test-performance.json`)
- "兼容性"/"compatibility" → 兼容性矩阵表 (`${tables}/test-compatibility.json`)

#### 数据库类章节关键词 → 图表类型
- "概念设计"/"conceptual" + 具体表名 → 单表 ER 图 (`${er}/Tab-*.svg`)
- "逻辑设计"/"logical" → 总体 ER 图 (`${uml}/er-overall.png`)
- "物理设计"/"physical" + 具体表名 → 三线表 (`${tables}/Tab-*.json`)

### 层级深度规则
- **一级章节**（id 如"3"、"4"）：默认仅 text，除非标题含明确图表关键词
- **二级章节**（id 如"3.1"、"4.2"）：
  - 有三级子节点 → 默认不写 text
  - 无子节点 → 写 text + 根据标题判断是否需要图
  - 特殊：若标题含"访问"/"流程"/"数据流"等，即使有子节点也可带 content+图
- **三级章节**（id 如"3.1.1"）：必须有 text + 根据标题智能判断图表
- **四级及以下**：必须有 text，图表需求依据标题关键词

### 参考论文学习机制
若用户提供参考论文结构（图片/JSON/Markdown），执行：
1. 提取参考论文的章节结构模式
2. 识别"哪些父章节带内容"/"哪些章节带图"的规律
3. 将学习到的模式应用到当前大纲，覆盖默认规则
4. 在 content-plan 输出时注释说明"参考 XXX 论文结构"

正文/图表需求判定（当模板未显式给出时）
- 需要图：用例图、架构图、功能结构图（WBS）、活动图、时序图、数据流图、流程图、实体概念图、总体 ER 图、关键流程/状态转换
- 需要表：数据库表结构（三线表）、测试用例表、性能指标表、兼容性矩阵
- 其余章节默认仅 text；若源码中存在明显图形结构证据（如状态机/流程 DSL），可补充 imagePath

## 父子章节内容规则

### 基础规则
- **三级及以下节点**：必须写 text
- **二级节点**：默认规则如下，但可被"参考论文学习"或"关键词判断"覆盖
  - 有子节点 → 默认不写 text
  - 无子节点 → 必须写 text
- **一级章节**：默认不写 text，但若标题含"测试"/"评价"等总结性词汇，可添加简短描述（150-200 字）

### 覆盖规则（优先级更高）
1. **关键词触发**：若章节标题含以下关键词，即使有子节点也应写 text+图：
   - "访问流程"、"系统流程"、"数据流"
   - "逻辑设计"、"架构"、"结构"

2. **参考论文驱动**：若提供参考论文，其对应章节有内容则跟随

3. **源码证据**：若源码中存在清晰的流程/状态机/配置，该章节可带 content+图

- 扁平化输出中仍以各自 id 记录，但遵守上述 text 填充规则

字数限制规则（word_limit 分配策略）
基于章节类型、内容深度与重要性动态分配字数，确保内容详略得当：

A. 前言类章节
- 摘要 (Abstract)：200-300字
- 关键词 (Keywords)：3-5个词组，约20-30字
- 目录、致谢等：50-100字

B. 第1章 绪论
- 1.1 研究背景：300-500字
- 1.2 研究意义：200-300字
- 1.3 研究内容与目标：300-400字
- 1.4 技术介绍各项：150-200字/项
- 1.5 论文结构：100-150字

C. 第2章 系统分析
- 2.1 需求分析总述：200-300字
- 2.2 功能需求：400-600字
- 2.2.3 用例描述：100-150字/用例
- 2.3 非功能需求：300-400字
- 2.4 可行性分析各项：200-300字/项

D. 第3章 概要设计
- 3.1 设计原则：200-300字
- 3.2 软件逻辑架构：300-400字
- 3.3 功能结构设计：200-300字
- 3.4.1 概念设计实体：70字/实体（包含完整字段列表和三线表引用）
- 3.4.2 逻辑设计：250-350字

E. 第4章 详细设计
- 4.1 功能详细设计：400-500字/模块
- 4.2 数据库详细设计：70字/表（包含完整字段列表和三线表引用）
- 4.3 小结：100-150字

F. 第5章 系统实现
- 5.1 开发环境与工具：200-300字
- 5.2 功能实现：300-400字/功能模块
- 5.3 小结：100-150字

G. 第6章 测试
- 6.1 测试环境：150-200字
- 6.2 测试策略：200-250字
- 6.3 功能测试：200-300字/功能模块
- 6.4 性能测试：300-400字
- 6.5 兼容性测试：200-250字
- 6.6 小结：100-150字

H. 结论相关
- 结论与展望：400-500字
- 参考文献条目：按实际需要

模块化填充要点（结合模板提示并对齐大纲）
A. 摘要 / 关键词 / Abstract / Keywords
- 填写概述文本；若模板要求图/表则补齐占位（通常无需）

B. 第1章 绪论
- 1.1~1.3 按是否含下级决定 text 归属；1.4 相关技术介绍按源码/依赖识别 3 项代表性技术分别填充 text

C. 第2章 系统分析
- 2.2.3 “系统用例图” → items 列表，≤5 个角色：每项含 title+text+imagePath，图片为用例图占位
- 非功能与可行性分解为 text（技术/经济/操作）

D. 第3章 概要设计
- 3.2 软件逻辑架构：text + 架构图 imagePath: `${uml}/software-architecture.png`
- 3.3 功能结构图：text + **WBS 图** imagePath: `${uml}/wbs-function.png`（必须使用 @startwbs/@endwbs、*/**/*** 层级）
- 3.4 数据库设计：
  - 3.4.1 概念设计：以 list 形式枚举**所有实体**（不允许缺少任何一个），items 每项包含：
    * title: 实体名称
    * text: 详细描述，格式为："[表名]，主要储存了本系统[功能描述]的相关信息，其中包含[字段中文名] ([英文字段名])、[字段中文名] ([英文字段名])..."
    * imagePath: 使用变量路径 `${er}/Tab-<tableName>.svg`（来臺workflow 01生成）
  - 3.4.2 逻辑设计：text + 总体 ER 图 imagePath: `${uml}/er-overall.png`

E. 第4章 详细设计
- 4.1 功能详细设计：从源码识别 ≤5 个核心模块（集合 M）
- 4.2 数据库详细设计：以 list 形式枚举**所有数据库表**（不允许缺少任何一个），items 每项包含：
  * title: 表名称
  * text: 详细描述，格式为："[表名]，主要储存了本系统[功能描述]的相关信息，其中包含[字段中文名] ([英文字段名])、[字段中文名] ([英文字段名])...，[表名]的数据库设计如下表，表X-X [表名] [tableName]所示。"
  * tablePath: 使用变量路径 `${tables}/Tab-<tableName>.json`（来臺workflow 00生成）
- 4.3 访问流程/数据流图：根据大纲标题自动判断
  * 标题含"数据流图"/"DFD" → 使用数据流图路径 `${dfd}/*`
  * 标题含"活动图"/"流程" → 使用活动图路径 `${uml}/activity-*`
  * 4.3 本身可以有 text+图（打破"有子节点则无内容"规则）
  * 4.3.1 作为总览图，4.3.1.x 作为分解图（各自独立节点，非 items 数组）
- 4.4 类图/其他图：若大纲存在此节点，自动添加对应图类型

### 第4章图表类型决策树
```
检查 4.x 章节标题
├─ 含"数据流" → ${dfd}/ 路径系列
├─ 含"活动" → ${uml}/activity-* 路径系列
├─ 含"时序" → ${uml}/sequence-* 路径系列
├─ 含"类图" → ${uml}/class-diagram.png
└─ 其他 → 根据"图表智能识别引擎"规则判断
```

F. 第5章 实现
- 5.1 环境与工具：text
- 5.2 系统功能实现：与集合 M 一一对应；每模块分为两个子节点：
  * 5.x.1 功能描述：text + 流程图 imagePath: `${flow}/flow-<moduleName>.png`
  * 5.x.2 实现过程：text + 实现截图 imagePath: `${impl}/impl-<moduleName>.png`
  * 注意：5.x.1 的"流程图"是传统流程图（矩形+菱形），非 UML 活动图
- 5.3 小结：text

G. 第6章 测试
- 6.1/6.2：text
- 6.3 功能测试：与集合 M 一一对应；每模块测试用例三线表 tablePath: `${tables}/test-<moduleName>.json` + text
- 6.4 性能测试：性能指标三线表 tablePath: `${tables}/test-performance.json` + text
- 6.5 兼容性测试：兼容性矩阵三线表 tablePath: `${tables}/test-compatibility.json` + text
- 6.6 小结：text

证据与优先级
- 代码与配置（Controller/Router/Service/Entity/DDL/迁移/前端路由与页面/工程脚本） > 文档 > 命名与目录启发 > 经验推断（需注明“依据不足”）

输出要求
- 生成**单一 JSON 数组（扁平化）**，每个对象严格包含：id、title、word_limit，以及按规则选择性加入 text / imagePath / tablePath / items
- 所有图片/表格路径使用变量路径规范（如 `${uml}/activity-auth.png`，不得留空）
- word_limit 字段必须根据上述字数限制规则分配，确保内容生成时字数合理控制
- items 数组中的元素也需包含 word_limit 字段
- 功能模块集合 M 在 4.1 / 5.2 / 6.3 中名称与顺序一致

容错
- 若遇到大纲与模板冲突：以大纲为准进行章节容器定位；模板内容按语义映射补齐
- 若证据不足：仍填充占位，并在 text 中明确“依据不足，待补充”
- 仅为“填充计划”，**不生成**实际 PNG/JSON 文件

## 路径生成示例
生成的content-plan.json应包含变量路径：
```json
{
  "id": "3.4.1.1",
  "title": "用户表设计",
  "text": "用户表存储系统用户的基本信息...",
  "imagePath": "${er}/Tab-users.svg",
  "tablePath": "${tables}/Tab-users.json",
  "word_limit": 300
},
{
  "id": "4.1.1",
  "title": "用户认证模块",
  "text": "用户认证模块负责...",
  "imagePath": "${uml}/activity-auth.png",
  "imagePathSequence": "${uml}/sequence-auth.png",
  "word_limit": 500
},
{
  "id": "5.2.1",
  "title": "用户认证实现",
  "text": "用户认证功能实现...",
  "imagePath": "${impl}/impl-auth.png",
  "word_limit": 400
}
```

现在开始：
1) 若提供参考论文，先分析参考论文的结构模式（哪些章节带图/表，父章节是否带内容等）
2) 解析 ./paper/outline.json 与 ./templates/content.template.json，列出差异并建立映射计划（内部执行，不需要输出映射表）
3) 解析 ./source 与 ./CLAUDE.md，识别功能模块集合 M（≤5），并对齐到 4.1/5.2/6.3
4) 对每个章节应用"图表智能识别引擎"：
   - 基于标题关键词判断图表类型
   - 结合层级深度决定是否需要 text
   - 若有参考论文模式，优先应用学习到的规律
5) 依据上述规则，输出最终"扁平化 JSON 填充计划"，并在注释中说明决策依据