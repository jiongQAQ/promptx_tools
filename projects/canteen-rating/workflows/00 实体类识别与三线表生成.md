# 00 实体类识别与三线表生成

## 路径规范
projectRoot 取当前工作目录（pwd）的绝对路径

## 功能说明
自动扫描源码目录，识别实体类定义，提取字段信息并生成标准化的三线表JSON文件，为论文数据表设计章节提供支撑。

## 目标任务
1. **实体类识别**：扫描 `<projectRoot>/source/` 目录，自动识别所有数据模型文件：
   - Java：@Entity/@Table 等注解的类，或 entity/pojo 目录下的类
   - Python：Django/SQLAlchemy 模型类
   - Node.js：Sequelize/Mongoose schema
   - Go：gorm.Model 或带结构体标签的定义
   - SQL：已有 CREATE TABLE 语句
   - 其他语言：凡定义了数据表/实体的数据结构文件

2. **字段信息提取**：提取每个实体的完整字段信息（字段名、类型、约束、说明），并为表与字段补充中文显示名：
   - 表中文名（tableCnName）
   - 字段中文名（逐字段）

3. **三线表生成**：为每个实体生成标准化的三线表JSON文件，用于后续渲染

## 输入要求
- **源码目录**：`<projectRoot>/source/`
- **配置文件**（可选）：`<projectRoot>/CLAUDE.md` - 若包含数据字典或命名规范，优先按其中规则命名中文名

## 输出结构

### 1. 三线表 JSON 文件
- **存放路径**：`<projectRoot>/paper/exports/tables/`
- **文件命名**：`Tab-<tableName>.json`（tableName 一律小写 + 下划线）
- **内容结构**：
```json
{
  \"tableName\": \"users\",
  \"tableCnName\": \"用户表\",
  \"columns\": [
    [\"字段名\", \"字段中文名\", \"类型\", \"约束\", \"说明\"],
    [\"id\", \"编号\", \"BIGINT\", \"PK, NOT NULL\", \"主键\"],
    [\"username\", \"用户名\", \"VARCHAR(50)\", \"NOT NULL\", \"登录账号\"],
    [\"password\", \"密码\", \"VARCHAR(255)\", \"NOT NULL\", \"加密存储\"],
    [\"created_time\", \"创建时间\", \"DATETIME\", \"\", \"记录生成时间\"]
  ]
}
```

### 2. 机器可读 JSON 摘要（stdout 单行）
```json
{
  \"status\": \"success\",
  \"project\": \"<projectName>\",
  \"entityCount\": 5,
  \"tableJsonDir\": \"<projectRoot>/paper/exports/tables/\",
  \"tables\": [
    {\"name\":\"users\",\"cn\":\"用户表\",\"columns\":5},
    {\"name\":\"orders\",\"cn\":\"订单表\",\"columns\":8}
  ],
  \"failList\": [
    {\"file\":\"Payment.java\",\"field\":\"totalAmount\",\"reason\":\"类型未识别\"}
  ]
}
```

### 3. 人类可读检查报告
- 实体总数与列表（表英文名 → 表中文名）
- 每表字段数、示例前几行
- 已生成 JSON 文件列表（相对路径）
- 未识别字段/类型（若有）
- 中文名来源与覆盖规则说明
- 确认所有三线表 JSON 已写入
- 下一步建议（进入流程 3 正文/图表生成）

## 中文名识别规则

### 优先级排序（从强到弱）

#### 1. 明确证据（最高优先）
- 代码注解/标签/元数据上的中文：
  - JPA `@Column(comment=\"用户名\")`
  - Django `verbose_name`
  - Sequelize/Mongoose 的 `comment/label`
  - Go struct tag `comment:\"用户ID\"`
- SQL COMMENT 或 `/* 中文说明 */`、`-- 中文注释`
- `<projectRoot>/CLAUDE.md` 或 docs 中的字段/表中英文对照表

#### 2. 结构化线索
- 文件/类/集合名中的中文片段（若存在）
- 领域词典映射（如 user→用户、order→订单、payment→支付）
- 常见时间字段：created_at→创建时间、updated_at→更新时间、is_xxx→是否XXX

#### 3. 形态学与模式映射（无显式证据时）
- 蛇形/驼峰分词 → 基础词典映射 + 常见后缀翻译：
  - `id`→编号、`code`→编码、`name`→名称、`title`→标题
  - `desc/description`→描述、`remark`→备注、`status`→状态
  - `type`→类型、`count`→数量、`total/amount`→金额、`price`→价格
  - `time/at/date`→时间/日期
  - `is_/has_` 前缀→\"是否…\"

#### 4. 覆盖策略
- 多处证据冲突时，按优先级 1 > 2 > 3 采纳
- `<projectRoot>/CLAUDE.md` 的明确表述与优先级 1 同级
- 采纳结果在报告中给出\"来源说明\"（文件/注解/规则）

## 字段类型映射

### 语言 → 通用 SQL 类型映射
- **Java**: String→VARCHAR(255)，int/Integer→INT，long/Long→BIGINT，LocalDate/LocalDateTime/Date→DATE/DATETIME，boolean→TINYINT(1)
- **Python**: CharField(n)→VARCHAR(n)，Text→TEXT，Integer→INT，Float/Decimal→DECIMAL(10,2)，DateTime→DATETIME，Boolean→TINYINT(1)
- **JS/TS**: STRING(n)→VARCHAR(n)，INTEGER→INT，BIGINT→BIGINT，DATE→DATETIME，BOOLEAN→TINYINT(1)
- **Go**: string→VARCHAR(255)，int→INT，int64→BIGINT，time.Time→DATETIME

### 约束拼接规则
- **主键**：PK
- **非空**：NOT NULL
- **唯一**：UNIQUE
- **自增**：AUTO_INCREMENT
- **默认值**：DEFAULT <val>
- 未识别时留空或标记 UNKNOWN，并在 failList 中记录

## 命名与输出规范
- **表名与字段名**：统一小写 + 下划线；不改源码中的真实命名，仅用于输出规范
- **文件目录**：`<projectRoot>/paper/exports/tables/`（若不存在需创建）
- **仅生成 JSON 文件**，不覆盖其它输出

## 容错机制
- 必须覆盖所有实体；若某实体解析失败，在报告中记录并继续处理其他实体
- 字段无法识别类型 → 用 UNKNOWN 并进入 failList
- 若未识别到任何实体，应报告\"未发现可解析的实体定义\"，并退出

## 使用场景
- 论文数据库设计章节的表格生成
- 系统分析阶段的实体梳理
- 数据字典的自动化生成
- 代码文档的标准化输出

## 前置条件
- 执行前请确保在项目根目录下运行
- 源码目录 `source/` 存在且包含实体定义文件
- 具备相应语言的代码解析能力

## 下一步流程
生成完成后，可进入后续的图表渲染或正文生成流程。