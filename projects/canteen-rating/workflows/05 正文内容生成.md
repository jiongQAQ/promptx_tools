# 📌 正文内容生成

## 智能批量处理架构

### 🎯 设计原理
本工作流程基于chapter-batch-processor工具实现智能批量处理：

- **智能扫描**：自动扫描并识别需要生成内容的章节
- **分批处理**：将大量章节分成小批次，避免疲劳导致质量下降
- **状态管理**：支持处理进度跟踪和中断恢复
- **工具集成**：使用专业的chapter-batch-processor工具自动化处理

### 📊 批量处理特性
- **自动规划**：自动分析章节需求，生成处理指令
- **分治策略**：采用分治法处理大量章节任务，每批4个章节
- **质量保证**：通过分批处理确保每个章节的内容质量
- **错误隔离**：单个章节问题不影响整体流程

## 路径规范
projectRoot 取当前工作目录（pwd）的绝对路径

## 使用chapter-batch-processor工具

### 工具集成策略
使用专业的chapter-batch-processor工具进行批量处理：
- **工具名称**：`chapter-batch-processor`
- **调用方式**：`toolx("@tool://chapter-batch-processor", parameters)`
- **核心功能**：自动扫描、分批规划、生成处理指令

### 核心处理流程
1. **智能扫描阶段**：
   ```json
   {
     "action": "scan",
     "projectPath": "<projectRoot>"
   }
   ```
   - 自动扫描`<projectRoot>/paper/chapters/`目录
   - 识别需要生成content的章节（content为空或少于50字符）
   - 返回待处理章节清单

2. **批量处理阶段**：
   ```json
   {
     "action": "process-all",
     "batchSize": 4,
     "projectPath": "<projectRoot>"
   }
   ```
   - 自动分批规划（默认每批4个章节）
   - 生成详细的处理指令
   - 包含激活PRA角色的步骤

### 工具输出说明
chapter-batch-processor会返回：
- **扫描结果**：总章节数、需处理章节数、章节清单
- **处理指令**：分批处理的详细指令序列
- **执行计划**：每批次包含的具体章节和要求

## 处理逻辑

### 字数控制策略
- **存在 word_limit 字段**：按照指定字数生成内容（允许 ±10% 浮动）
- **不存在 word_limit 字段**：默认生成 500 字左右
- **章节层级自适应**：
  - 一级章节（如 "第1章"）：800-1000 字
  - 二级章节（如 "1.1"）：600-800 字
  - 三级章节（如 "1.1.1"）：400-600 字
  - 四级及以下：300-500 字

### 内容生成原则
1. **激活pra角色**：在开始每批处理前先激活promptx的pra角色
2. **基于 prompt 字段**：严格按照 prompt 中的写作要求生成内容
3. **保持学术风格**：使用学术化表达，逻辑清晰，层次分明
4. **上下文连贯**：考虑章节在整体论文中的位置和作用
5. **技术描述规范**：确保技术描述准确但避免过度技术化
6. **内容完整性**：覆盖 prompt 中要求的所有要点

### 特殊处理规则
- **包含 imagePath 的章节**：
  - 生成时假设图片存在且内容丰富
  - 在正文中自然引用图片："如图X所示..."
  - 描述图片表达的核心概念和关系

- **包含 tablePath 的章节**：
  - 生成时假设表格数据完整
  - 在正文中分析表格内容："表X展示了..."
  - 解读表格数据的意义和设计合理性

- **系统实现相关章节**：
  - **严格避免代码片段**：不包含任何源代码、配置文件内容
  - **不提及文件路径**：避免具体的代码文件路径或目录结构描述
  - **专注功能描述**：从用户角度描述系统功能特点和使用体验
  - **突出设计思想**：强调架构理念、技术选型的合理性和优势
  - **业务价值导向**：重点说明功能对实际应用场景的解决方案

## 完整执行流程

### Phase 1: 工具调用与扫描
```bash
# Step 1: 调用chapter-batch-processor进行扫描
toolx("@tool://chapter-batch-processor", {
  "action": "scan",
  "projectPath": "/Users/pc/Documents/promptx_tools/projects/canteen-rating"
})
```

### Phase 2: 批量处理规划
```bash
# Step 2: 生成批量处理指令
toolx("@tool://chapter-batch-processor", {
  "action": "process-all",
  "batchSize": 4,
  "projectPath": "/Users/pc/Documents/promptx_tools/projects/canteen-rating"
})
```

### Phase 3: 按指令执行处理
根据chapter-batch-processor返回的instructions按顺序执行：

1. **激活PRA角色**：
   ```bash
   mcp__promptx__action({ "role": "pra" })
   ```

2. **分批处理章节**：
   对每个批次执行以下操作：
   - 读取批次中每个章节的JSON文件
   - 根据prompt字段生成学术化content内容
   - 遵守word_limit字数限制（±10%浮动）
   - 使用Edit工具更新JSON文件的content字段
   - 保持其他字段不变

### AI执行流程优化
基于chapter-batch-processor的指令，AI执行流程变为：
1. **工具驱动**：由chapter-batch-processor工具自动规划任务
2. **批次专注**：每次专注处理一个批次（4个章节）
3. **指令明确**：每个章节都有明确的处理指令和要求
4. **进度可控**：可以暂停和恢复，支持分阶段处理

## 输入源文件
```
<projectRoot>/paper/chapter/
├── chapter.0.json          # 摘要
├── chapter.1.json          # 第1章 绪论
├── chapter.1.1.json        # 研究背景与意义
├── chapter.1.1.1.json      # 研究背景
├── chapter.2.2.3.json      # 用例分析
├── chapter.3.2.json        # 系统软件逻辑架构
└── ...
```

## 工具使用示例

### 完整工作流示例

**Step 1: 扫描章节需求**
```bash
# 调用工具扫描
toolx("@tool://chapter-batch-processor", {
  "action": "scan",
  "projectPath": "/Users/pc/Documents/promptx_tools/projects/canteen-rating"
})

# 返回结果示例
{
  "success": true,
  "total": 54,
  "needProcessing": 12,
  "chapters": [
    {
      "id": "1.1.1",
      "title": "研究背景",
      "file": "chapter.1.1.1.json",
      "needsContent": true,
      "wordLimit": 600
    }
    // ... 其他章节
  ]
}
```

**Step 2: 生成批量处理指令**
```bash
# 调用工具生成处理计划
toolx("@tool://chapter-batch-processor", {
  "action": "process-all",
  "batchSize": 4,
  "projectPath": "/Users/pc/Documents/promptx_tools/projects/canteen-rating"
})

# 返回结果示例
{
  "success": true,
  "message": "已规划12个章节的处理任务，分3批执行",
  "totalChapters": 12,
  "batches": 3,
  "batchSize": 4,
  "instructions": [
    {
      "step": 0,
      "action": "activate_pra",
      "description": "激活PRA角色进行专业论文写作",
      "command": "mcp__promptx__action",
      "params": { "role": "pra" }
    },
    {
      "step": 1,
      "action": "process_batch",
      "description": "处理批次1/3",
      "chapters": [
        {
          "id": "1.1.1",
          "title": "研究背景",
          "file": "/path/to/chapter.1.1.1.json",
          "instruction": "读取文件，根据prompt字段生成content内容，使用Edit工具更新文件"
        }
        // ... 批次中的其他章节
      ]
    }
    // ... 其他批次指令
  ]
}
```

**Step 3: 按指令执行**
根据返回的instructions逐步执行，确保高质量的批量处理。

## 质量标准
- **字数符合要求**：生成内容字数在目标范围内（允许 ±10% 浮动）
- **逻辑结构清晰**：段落层次分明，论述逻辑严密
- **学术表达规范**：用词准确，符合学术论文写作规范
- **内容充实完整**：覆盖 prompt 要求的所有关键点
- **技术描述准确**：涉及技术内容时保证准确性和专业性

## 使用chapter-batch-processor的优势

### 自动化优势
- **智能扫描**：自动识别需要处理的章节，无需手动检查
- **分批规划**：自动将大量章节分成合理的小批次
- **指令生成**：生成详细的处理指令，减少人工规划
- **进度跟踪**：可以清楚了解处理进度和剩余任务

### 质量保证优势
- **避免疲劳**：分批处理避免一次性处理过多导致质量下降
- **专注处理**：每批只处理4个章节，确保专注度和质量
- **一致性**：所有章节使用相同的处理标准和质量要求
- **可恢复性**：支持中断和恢复，可以分多次完成

### 工作流优势
- **标准化**：提供标准化的批量处理流程
- **可复用**：可以用于其他项目的章节批量处理
- **错误隔离**：单个章节问题不影响其他章节处理
- **效率提升**：大幅减少手动操作和重复性工作

## AI执行建议

### 使用流程建议
1. **首先调用扫描**：了解总体任务量和需求
2. **查看处理计划**：确认批次划分和处理策略
3. **激活PRA角色**：确保专业论文写作质量
4. **按批次执行**：严格按照指令逐批处理
5. **验证结果**：处理完成后可再次扫描验证

### 注意事项
- **路径正确**：确保projectPath参数指向正确的项目目录
- **批次大小**：建议使用默认的4个章节/批次，避免疲劳
- **指令遵循**：严格按照返回的instructions执行
- **质量优先**：如果某个章节质量不满意，可以重新处理

## 前置条件
- 项目目录结构正确：`<projectRoot>/paper/chapters/`存在
- 章节JSON文件格式正确：包含id、title、prompt等字段
- 确保chapter-batch-processor工具可用