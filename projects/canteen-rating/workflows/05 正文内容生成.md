# 📌 正文内容生成（Claude Code Hook驱动）

## Hook驱动的单章节专注架构

### 🎯 设计原理
本工作流程基于Claude Code的Hook机制，实现单章节专注处理模式：

- **UserPromptSubmit Hook**：每次只提供单个章节任务，确保AI专注
- **Stop Hook**：自动检测章节完成，标记进度并触发下一个章节
- **工作流程文档**（本文档）：定义单章节处理标准和执行要求
- **专注机制**：AI不知道总任务量，只专注处理当前章节

### 🚀 用户交互流程
用户只需发送一次启动指令，Hook自动循环处理所有章节：

```bash
# 启动流程（只需一次）
开始05流程

# 后续完全自动，无需任何手动干预
```

### 📊 单章节专注特性
- **单任务专注**：AI每次只看到一个章节，避免分心和选择困难
- **自动循环**：完成当前章节后自动进入下一章节
- **状态持久化**：进度保存在`.chapter-progress.json`，支持中断恢复
- **智能检测**：Stop Hook检测完成标志，自动推进流程
- **无感知处理**：AI不知道剩余任务数，专注当下任务

## 路径规范
projectRoot 取当前工作目录（pwd）的绝对路径

## 单章节专注处理要求

### 核心任务
专注处理Hook提供的单个章节，完成text字段内容生成：
- **首先激活promptx的pra角色**进行专业化内容生成
- **专注当前章节**：只处理Hook指定的单个章节，忽略其他章节
- 严格按照该章节的prompt字段要求生成内容
- 遵守该章节的word_limit字数限制（允许±10%浮动）
- 仅更新该章节的text字段，保持其他字段不变
- 使用Edit工具直接修改对应的JSON文件
- **完成即结束**：处理完当前章节后简单报告完成，不询问下一步

## 处理逻辑

### 字数控制策略
- **存在 word_limit 字段**：按照指定字数生成内容（允许 ±10% 浮动）
- **不存在 word_limit 字段**：默认生成 500 字左右
- **章节层级自适应**：
  - 一级章节（如 "第1章"）：800-1000 字
  - 二级章节（如 "1.1"）：600-800 字
  - 三级章节（如 "1.1.1"）：400-600 字
  - 四级及以下：300-500 字

### 内容生成原则
1. **激活pra角色**：在开始每批处理前先激活promptx的pra角色
2. **基于 prompt 字段**：严格按照 prompt 中的写作要求生成内容
3. **保持学术风格**：使用学术化表达，逻辑清晰，层次分明
4. **上下文连贯**：考虑章节在整体论文中的位置和作用
5. **技术描述规范**：确保技术描述准确但避免过度技术化
6. **内容完整性**：覆盖 prompt 中要求的所有要点

### 特殊处理规则
- **包含 imagePath 的章节**：
  - 生成时假设图片存在且内容丰富
  - 在正文中自然引用图片："如图X所示..."
  - 描述图片表达的核心概念和关系

- **包含 tablePath 的章节**：
  - 生成时假设表格数据完整
  - 在正文中分析表格内容："表X展示了..."
  - 解读表格数据的意义和设计合理性

- **系统实现相关章节**：
  - **严格避免代码片段**：不包含任何源代码、配置文件内容
  - **不提及文件路径**：避免具体的代码文件路径或目录结构描述
  - **专注功能描述**：从用户角度描述系统功能特点和使用体验
  - **突出设计思想**：强调架构理念、技术选型的合理性和优势
  - **业务价值导向**：重点说明功能对实际应用场景的解决方案

## Hook驱动的处理流程

### 自动化流程（Hook负责）
1. **触发检测**：UserPromptSubmit Hook检测"05流程"关键词
2. **状态初始化**：首次运行时扫描chapters目录，创建进度文件
3. **单章节准备**：根据进度状态准备当前需要处理的单个章节
4. **上下文注入**：为当前章节注入详细信息和处理要求
5. **完成检测**：Stop Hook检测章节完成，自动标记进度并触发下一章节

### AI执行流程（单章节模式）
1. **激活专业角色**：首先激活promptx的pra角色以确保专业化论文写作
2. **接收单章节任务**：Hook自动提供当前需要处理的单个章节
3. **专注处理当前章节**：
   - 读取该章节JSON文件的prompt、word_limit等信息
   - 根据本文档的内容生成原则为该章节创建text内容
   - **严格遵守无代码原则**：生成的内容不包含代码片段和文件路径
   - 使用Edit工具更新该章节对应的JSON文件
4. **完成报告**：处理完成后简单说明已完成该章节，Hook会自动检测并推进

## 输入源文件
```
<projectRoot>/paper/chapter/
├── chapter.0.json          # 摘要
├── chapter.1.json          # 第1章 绪论
├── chapter.1.1.json        # 研究背景与意义
├── chapter.1.1.1.json      # 研究背景
├── chapter.2.2.3.json      # 用例分析
├── chapter.3.2.json        # 系统软件逻辑架构
└── ...
```

## Hook批次处理示例

### Hook自动注入的上下文示例
当用户发送"开始05流程"时，Hook自动注入：

```
🚀 开始05流程：已发现54个章节文件，准备分批处理。

📖 **参考文档**: workflows/05 正文内容生成.md
请按照该文档中的内容生成原则、特殊处理规则和质量标准执行。

📋 当前处理第1批章节（共14批）：

需要处理的章节：
1. 章节 0: 摘要
   生成要求: 请基于源码和论文主题，撰写《摘要》的正文...
   字数要求: 500字

2. 章节 0.1: 关键词
   生成要求: 请基于源码和论文主题，撰写《关键词》的正文...
   字数要求: 100字

📈 进度: 0/54 (0.0%)

🎯 处理要求：
1. **首先激活pra角色**：开始处理前先激活promptx的pra角色
2. 逐个处理章节，为每个章节生成text字段内容
3. **严格无代码原则**：生成内容不包含代码片段和文件路径
4. 使用MultiEdit或Edit工具更新对应的JSON文件
5. 仅更新text字段，保持其他字段不变
6. **重要**：处理完成后必须主动说'继续05流程'来触发下一批
```

### 单章节处理示例
基于Hook提供的信息，AI处理单个章节：

**输入**：chapter.1.1.1.json
```json
{
  "id": "1.1.1",
  "title": "研究背景",
  "prompt": "请基于源码和论文主题，撰写《研究背景》的正文...",
  "word_limit": 600
}
```

**AI执行**：
1. 激活promptx的pra角色进行专业论文写作
2. 阅读prompt要求和word_limit限制
3. 按照本文档的内容生成原则创建600字左右的学术化内容
4. 严格避免代码片段和文件路径描述
5. 使用Edit工具更新JSON文件，仅添加text字段

**输出**：chapter.1.1.1.json
```json
{
  "id": "1.1.1",
  "title": "研究背景",
  "text": "随着我国高等教育事业的快速发展，高校规模不断扩大，在校师生数量持续增长。校园食堂作为师生日常生活的重要服务场所，其服务质量直接关系到师生的生活满意度和身心健康。然而，传统的食堂管理模式普遍存在信息化程度不高、服务反馈机制不完善等问题...",
  "prompt": "请基于源码和论文主题，撰写《研究背景》的正文...",
  "word_limit": 600
}
```

## 质量标准
- **字数符合要求**：生成内容字数在目标范围内（允许 ±10% 浮动）
- **逻辑结构清晰**：段落层次分明，论述逻辑严密
- **学术表达规范**：用词准确，符合学术论文写作规范
- **内容充实完整**：覆盖 prompt 要求的所有关键点
- **技术描述准确**：涉及技术内容时保证准确性和专业性

## AI执行注意事项

### 单章节处理要求
- **专注当前章节**：只处理Hook提供的当前章节，不询问或考虑其他章节
- **无需全局感知**：不需要了解剩余章节数量或整体进度
- **仅更新text字段**：保持JSON文件的其他字段完全不变
- **工具使用**：使用Edit工具更新当前章节对应的JSON文件
- **文件操作**：直接修改chapters目录下对应的JSON文件，不创建新文件
- **完成即结束**：处理完当前章节后简单报告，不主动询问下一步

### 内容生成规范
- **prompt优先**：严格按照每个章节的prompt字段要求生成内容
- **字数控制**：遵守word_limit限制，允许±10%浮动
- **质量标准**：按照本文档的内容生成原则和质量标准执行
- **连贯性**：考虑章节在整体论文中的位置和上下文关系

### 单章节完成流程
1. **专注处理**：专注处理Hook提供的当前单个章节
2. **文件更新**：处理完成后立即更新对应的JSON文件
3. **简单报告**：说明该章节已完成，无需询问后续步骤
4. **自动推进**：Stop Hook会自动检测完成并推进到下一章节

## Hook机制优势

### 自动化程度
- **用户友好**：用户只需发送一次指令，后续完全自动化
- **状态管理**：自动记录处理进度，支持中断恢复
- **单章节专注**：避免AI分心，每次专注处理一个章节
- **智能循环**：自动检测完成并推进到下一章节

### 质量保证
- **专注处理**：每次只处理一个章节，确保质量和深度
- **文档引导**：Hook自动引用本工作流程文档，确保AI遵循规范
- **自动推进**：Stop Hook智能检测完成标志，确保流程连续性
- **错误隔离**：单个章节问题不影响整体流程