# 📌 正文内容生成（Claude Code Hook驱动）

## Hook驱动的批次处理架构

### 🎯 设计原理
本工作流程基于Claude Code的UserPromptSubmit Hook机制，实现大规模章节内容的自动化分批生成：

- **Hook脚本**（05-chapter-hook.py）：负责任务编排和上下文注入
- **工作流程文档**（本文档）：定义内容生成标准和执行要求
- **协作机制**：Hook提供"做什么任务"，文档规范"如何做好"

### 🚀 用户交互流程
用户只需发送简单指令，Hook自动处理复杂的批次逻辑：

```bash
# 启动流程
开始05流程

# 继续处理（Hook自动准备下一批）
继续05流程
```

### 📊 批次处理特性
- **智能分批**：每批处理4个章节，避免AI过载
- **状态持久化**：进度保存在`.chapter-progress.json`，支持中断恢复
- **自动排序**：按章节编号（0, 0.1, 1, 1.1, 1.1.1...）顺序处理
- **进度跟踪**：实时显示处理进度和剩余章节数

## 路径规范
projectRoot 取当前工作目录（pwd）的绝对路径

## 单章节处理要求

### 核心任务
基于Hook提供的章节信息，为单个章节生成text字段内容：
- 严格按照章节的prompt字段要求生成内容
- 遵守word_limit字数限制（允许±10%浮动）
- 仅更新text字段，保持其他字段不变
- 使用MultiEdit或Edit工具直接修改JSON文件

## 处理逻辑

### 字数控制策略
- **存在 word_limit 字段**：按照指定字数生成内容（允许 ±10% 浮动）
- **不存在 word_limit 字段**：默认生成 500 字左右
- **章节层级自适应**：
  - 一级章节（如 "第1章"）：800-1000 字
  - 二级章节（如 "1.1"）：600-800 字
  - 三级章节（如 "1.1.1"）：400-600 字
  - 四级及以下：300-500 字

### 内容生成原则
1. **基于 prompt 字段**：严格按照 prompt 中的写作要求生成内容
2. **保持学术风格**：使用学术化表达，逻辑清晰，层次分明
3. **上下文连贯**：考虑章节在整体论文中的位置和作用
4. **技术准确性**：确保技术描述准确，符合软件工程规范
5. **内容完整性**：覆盖 prompt 中要求的所有要点

### 特殊处理规则
- **包含 imagePath 的章节**：
  - 生成时假设图片存在且内容丰富
  - 在正文中自然引用图片："如图X所示..."
  - 描述图片表达的核心概念和关系

- **包含 tablePath 的章节**：
  - 生成时假设表格数据完整
  - 在正文中分析表格内容："表X展示了..."
  - 解读表格数据的意义和设计合理性

- **代码实现章节**：
  - 结合项目源码特点描述实现细节
  - 突出技术选型和架构优势
  - 说明关键功能的实现思路

## Hook驱动的处理流程

### 自动化流程（Hook负责）
1. **触发检测**：Hook检测"05流程"关键词
2. **状态初始化**：首次运行时扫描chapter目录，创建进度文件
3. **批次准备**：根据进度状态准备当前批次（4个章节）
4. **上下文注入**：自动为每个章节注入详细信息和处理要求

### AI执行流程（遵循本文档）
1. **接收批次任务**：Hook自动提供当前批次的章节列表
2. **逐个处理章节**：
   - 读取章节JSON文件的prompt、word_limit等信息
   - 根据本文档的内容生成原则创建text内容
   - 使用MultiEdit/Edit工具更新对应的JSON文件
3. **完成反馈**：处理完成后发送"继续05流程"进入下一批次

## 输入源文件
```
<projectRoot>/paper/chapter/
├── chapter.0.json          # 摘要
├── chapter.1.json          # 第1章 绪论
├── chapter.1.1.json        # 研究背景与意义
├── chapter.1.1.1.json      # 研究背景
├── chapter.2.2.3.json      # 用例分析
├── chapter.3.2.json        # 系统软件逻辑架构
└── ...
```

## Hook批次处理示例

### Hook自动注入的上下文示例
当用户发送"开始05流程"时，Hook自动注入：

```
🚀 开始05流程：已发现54个章节文件，准备分批处理。

📖 **参考文档**: workflows/05 正文内容生成.md
请按照该文档中的内容生成原则、特殊处理规则和质量标准执行。

📋 当前处理第1批章节（共14批）：

需要处理的章节：
1. 章节 0: 摘要
   生成要求: 请基于源码和论文主题，撰写《摘要》的正文...
   字数要求: 500字

2. 章节 0.1: 关键词
   生成要求: 请基于源码和论文主题，撰写《关键词》的正文...
   字数要求: 100字

📈 进度: 0/54 (0.0%)

🎯 处理要求：
1. 逐个处理章节，为每个章节生成text字段内容
2. 使用MultiEdit或Edit工具更新对应的JSON文件
3. 仅更新text字段，保持其他字段不变
4. **重要**：处理完成后必须主动说'继续05流程'来触发下一批处理
```

### 单章节处理示例
基于Hook提供的信息，AI处理单个章节：

**输入**：chapter.1.1.1.json
```json
{
  "id": "1.1.1",
  "title": "研究背景",
  "prompt": "请基于源码和论文主题，撰写《研究背景》的正文...",
  "word_limit": 600
}
```

**AI执行**：
1. 阅读prompt要求和word_limit限制
2. 按照本文档的内容生成原则创建600字左右的学术化内容
3. 使用Edit工具更新JSON文件，仅添加text字段

**输出**：chapter.1.1.1.json
```json
{
  "id": "1.1.1",
  "title": "研究背景",
  "text": "随着我国高等教育事业的快速发展，高校规模不断扩大，在校师生数量持续增长。校园食堂作为师生日常生活的重要服务场所，其服务质量直接关系到师生的生活满意度和身心健康。然而，传统的食堂管理模式普遍存在信息化程度不高、服务反馈机制不完善等问题...",
  "prompt": "请基于源码和论文主题，撰写《研究背景》的正文...",
  "word_limit": 600
}
```

## 质量标准
- **字数符合要求**：生成内容字数在目标范围内（允许 ±10% 浮动）
- **逻辑结构清晰**：段落层次分明，论述逻辑严密
- **学术表达规范**：用词准确，符合学术论文写作规范
- **内容充实完整**：覆盖 prompt 要求的所有关键点
- **技术描述准确**：涉及技术内容时保证准确性和专业性

## AI执行注意事项

### 章节处理要求
- **严格按批次**：只处理Hook提供的当前批次章节，不要主动处理其他章节
- **仅更新text字段**：保持JSON文件的其他字段完全不变
- **工具使用**：优先使用MultiEdit进行批量更新，单个章节可用Edit
- **文件操作**：直接修改chapter目录下的JSON文件，不创建新文件

### 内容生成规范
- **prompt优先**：严格按照每个章节的prompt字段要求生成内容
- **字数控制**：遵守word_limit限制，允许±10%浮动
- **质量标准**：按照本文档的内容生成原则和质量标准执行
- **连贯性**：考虑章节在整体论文中的位置和上下文关系

### 批次完成流程
1. **逐个处理**：按Hook提供的章节顺序逐个生成text内容
2. **文件更新**：每个章节处理完成后立即更新对应的JSON文件
3. **主动触发**：所有章节处理完成后，AI必须主动说"继续05流程"
4. **错误处理**：如遇问题跳过该章节，在反馈中说明具体情况

## Hook机制优势

### 自动化程度
- **用户友好**：用户只需发送简单指令，复杂逻辑由Hook处理
- **状态管理**：自动记录处理进度，支持中断恢复
- **智能分批**：避免AI处理过载，提高生成质量
- **错误恢复**：失败章节可单独重新处理

### 质量保证
- **标准化流程**：每批都按相同标准处理，确保质量一致性
- **文档引导**：Hook自动引用本工作流程文档，确保AI遵循规范
- **进度可视**：实时显示处理进度，便于监控和管理